<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicToken Ring - Music Battle Arena</title>
   
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
   
    <!-- Styles -->
    <link rel="stylesheet" href="./styles/main.css">
   
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•ä</text></svg>">

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const CONFIG = {
            SUPABASE_URL: 'https://bscmgcnynbxalcuwdqlm.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzY21nY255bmJ4YWxjdXdkcWxtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTYwOTUsImV4cCI6MjA4NjAzMjA5NX0.1iasFQ5H0GmrFqi6poWNE1aZOtbmQuB113RCyg2BBK4',
            BATTLE_DURATION: 60
        };
        console.log('üéµ MusicToken Ring loaded!');
    </script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ü•ä</span>
                    <span class="logo-text">MusicToken Ring</span>
                </div>
                
                <div class="header-badges">
                    <span class="badge">üéµ Deezer</span>
                    <span class="badge badge-live">üî¥ Live</span>
                    <span class="badge" id="balanceDisplay">üí∞ 0 $MTOKEN</span>
                </div>
                
                <!-- AUTH BUTTON -->
                <div id="authButton">
                    <button onclick="openAuthModal()" class="btn-login">
                        Iniciar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            
            <!-- LOGIN WALL (mostrar si no est√° logueado) -->
            <section id="loginWall" class="login-wall">
                <div class="login-wall-content">
                    <div class="login-wall-icon">ü•ä</div>
                    <h1 class="login-wall-title">Bienvenido a MusicToken Ring</h1>
                    <p class="login-wall-subtitle">
                        Batalla con tus canciones favoritas, apuesta $MTOKEN y demuestra qui√©n tiene mejor gusto musical
                    </p>
                    <button onclick="openAuthModal()" class="btn-primary btn-large">
                        Iniciar Sesi√≥n para Jugar
                    </button>
                    <div class="login-wall-features">
                        <div class="feature-item">
                            <span class="feature-icon">‚öîÔ∏è</span>
                            <span class="feature-text">Modo R√°pido</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üé™</span>
                            <span class="feature-text">Salas Privadas</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üèÜ</span>
                            <span class="feature-text">Torneos</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üéØ</span>
                            <span class="feature-text">Modo Pr√°ctica</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SELECTOR DE MODO (mostrar si est√° logueado) -->
            <section id="modeSelector" class="mode-selector hidden">
                <div class="section-header">
                    <h1 class="section-title">Elige tu Modo de Juego</h1>
                    <p class="section-subtitle">Selecciona c√≥mo quieres competir</p>
                </div>

                <div class="modes-grid">
                    <!-- Modo R√°pido -->
                    <div class="mode-card" onclick="event.stopPropagation(); selectMode('quick');">
                        <div class="mode-icon">‚öîÔ∏è</div>
                        <h3 class="mode-title">Modo R√°pido</h3>
                        <p class="mode-description">
                            Matchmaking autom√°tico. Encuentra un rival en segundos y empieza a batallar.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üéØ Emparejamiento autom√°tico</span>
                            <span class="mode-feature">üí∞ Apuesta personalizada</span>
                            <span class="mode-feature">‚è±Ô∏è Partidas de 1 minuto</span>
                        </div>
                        <button class="btn-mode" onclick="event.stopPropagation(); selectMode('quick');">Jugar Ahora</button>
                    </div>

                    <!-- Sala Privada -->
                    <div class="mode-card" onclick="event.stopPropagation(); selectMode('private');">
                        <div class="mode-icon">üé™</div>
                        <h3 class="mode-title">Sala Privada</h3>
                        <p class="mode-description">
                            Crea una sala e invita a tus amigos. Personaliza las reglas y apuestas.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üë• Juega con amigos</span>
                            <span class="mode-feature">üîó C√≥digo de sala √∫nico</span>
                            <span class="mode-feature">‚öôÔ∏è Reglas personalizadas</span>
                        </div>
                        <button class="btn-mode" onclick="event.stopPropagation(); selectMode('private');">Crear Sala</button>
                    </div>

                    <!-- Torneo -->
                    <div class="mode-card" onclick="event.stopPropagation(); selectMode('tournament');">
                        <div class="mode-icon">üèÜ</div>
                        <h3 class="mode-title">Torneo</h3>
                        <p class="mode-description">
                            Compite en torneos de eliminaci√≥n. Gana premios masivos del prize pool.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üé™ M√∫ltiples rondas</span>
                            <span class="mode-feature">üíé Grandes premios</span>
                            <span class="mode-feature">üèÖ Rankings globales</span>
                        </div>
                        <button class="btn-mode" onclick="event.stopPropagation(); selectMode('tournament');">Unirse al Torneo</button>
                    </div>

                    <!-- Modo Pr√°ctica -->
                    <div class="mode-card" onclick="event.stopPropagation(); selectMode('practice');">
                        <div class="mode-icon">üéØ</div>
                        <h3 class="mode-title">Modo Pr√°ctica</h3>
                        <p class="mode-description">
                            Practica contra la CPU sin arriesgar tokens. Perfecto para nuevos jugadores.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üéÆ Sin riesgo</span>
                            <span class="mode-feature">üéÅ Peque√±as recompensas</span>
                            <span class="mode-feature">üìö Aprende a jugar</span>
                        </div>
                        <button class="btn-mode" onclick="event.stopPropagation(); selectMode('practice');">Practicar</button>
                    </div>
                </div>
            </section>

            <!-- SELECCI√ìN DE CANCI√ìN Y APUESTA -->
            <section id="songSelection" class="hidden">
                <div class="section-header">
                    <button onclick="backToModes()" class="btn-back">‚Üê Volver</button>
                    <h2 class="section-title" id="modeTitle">Modo R√°pido</h2>
                    <p class="section-subtitle">Elige tu canci√≥n y realiza tu apuesta</p>
                </div>

                <div class="selection-container">
                    <!-- B√∫squeda -->
                    <div class="search-panel">
                        <h3>üéµ Busca tu Canci√≥n</h3>
                        <div class="search-box">
                            <input 
                                type="text" 
                                id="songSearch" 
                                placeholder="Nombre de canci√≥n o artista..."
                                class="search-input"
                            >
                            <button onclick="searchSong()" class="search-btn">üîç</button>
                        </div>

                        <!-- Resultados -->
                        <div id="searchResults" class="results-grid"></div>
                    </div>

                    <!-- Selecci√≥n Actual y Apuesta -->
                    <div class="bet-panel">
                        <div class="selected-song" id="selectedSongCard">
                            <div class="no-selection">
                                <div class="no-selection-icon">üéµ</div>
                                <p>Selecciona una canci√≥n</p>
                            </div>
                        </div>

                        <div class="bet-section">
                            <h3>üí∞ Tu Apuesta</h3>
                            <div class="bet-info">
                                <span>Balance: <strong id="userBalance">0</strong> $MTOKEN</span>
                                <span>M√≠nimo: <strong id="minBet">100</strong> $MTOKEN</span>
                            </div>
                            <input 
                                type="number" 
                                id="betAmount" 
                                placeholder="100" 
                                min="100" 
                                class="bet-input"
                            >
                            <div class="bet-quick">
                                <button onclick="quickBet(100)" class="btn-quick">100</button>
                                <button onclick="quickBet(500)" class="btn-quick">500</button>
                                <button onclick="quickBet(1000)" class="btn-quick">1K</button>
                                <button onclick="quickBet(5000)" class="btn-quick">5K</button>
                            </div>

                            <!-- Botones seg√∫n modo -->
                            <div id="actionButtons"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PANTALLA DE ESPERA -->
            <section id="waitingScreen" class="hidden">
                <div class="waiting-content">
                    <div class="waiting-spinner">‚è≥</div>
                    <h2 class="waiting-title">Buscando Oponente...</h2>
                    <p class="waiting-subtitle">Esto puede tomar unos segundos</p>
                    <button onclick="cancelSearch()" class="btn-secondary">Cancelar B√∫squeda</button>
                </div>
            </section>

            <!-- PANTALLA DE SALA PRIVADA -->
            <section id="roomScreen" class="hidden">
                <div class="room-content">
                    <div class="room-header">
                        <h2>üé™ Sala Privada</h2>
                        <div class="room-code-display">
                            <span>C√≥digo:</span>
                            <strong id="roomCode">XXXXX</strong>
                            <button onclick="copyRoomCode()" class="btn-copy">üìã</button>
                        </div>
                    </div>
                    <div class="room-players">
                        <div class="room-player" id="player1Card">
                            <div class="player-avatar">üë§</div>
                            <span class="player-name">Esperando...</span>
                        </div>
                        <div class="room-vs">VS</div>
                        <div class="room-player" id="player2Card">
                            <div class="player-avatar">‚ùì</div>
                            <span class="player-name">Esperando rival...</span>
                        </div>
                    </div>
                    <p class="room-info">Comparte el c√≥digo con tu amigo</p>
                    <button onclick="leaveRoom()" class="btn-secondary">Salir de la Sala</button>
                </div>
            </section>

        </div>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal hidden">
        <div class="modal-overlay" onclick="closeAuthModal()"></div>
        <div class="modal-content auth-modal-content">
            <button onclick="closeAuthModal()" class="modal-close">√ó</button>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <h2 class="auth-title">Iniciar Sesi√≥n</h2>
                <p class="auth-subtitle">Accede a tu cuenta para guardar tu progreso</p>
                
                <!-- Google Login -->
                <button onclick="loginWithGoogle()" class="btn-google">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/>
                        <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                        <path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/>
                        <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                    </svg>
                    Continuar con Google
                </button>
                
                <div class="auth-divider">
                    <span>o</span>
                </div>
                
                <!-- Email Login -->
                <form onsubmit="handleLoginSubmit(event)">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input 
                            type="email" 
                            id="loginEmail" 
                            class="form-input" 
                            placeholder="tu@email.com"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">Contrase√±a</label>
                        <input 
                            type="password" 
                            id="loginPassword" 
                            class="form-input" 
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                        >
                    </div>
                    
                    <button type="submit" class="btn-primary btn-block">
                        Iniciar Sesi√≥n
                    </button>
                </form>
                
                <p class="auth-switch">
                    ¬øNo tienes cuenta? 
                    <a href="#" onclick="switchToSignup(); return false;">Reg√≠strate</a>
                </p>
            </div>
            
            <!-- Signup Form -->
            <div id="signupForm" class="auth-form hidden">
                <h2 class="auth-title">Crear Cuenta</h2>
                <p class="auth-subtitle">√önete a MusicToken Ring</p>
                
                <!-- Google Signup -->
                <button onclick="loginWithGoogle()" class="btn-google">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/>
                        <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                        <path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/>
                        <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                    </svg>
                    Continuar con Google
                </button>
                
                <div class="auth-divider">
                    <span>o</span>
                </div>
                
                <!-- Email Signup -->
                <form onsubmit="handleSignupSubmit(event)">
                    <div class="form-group">
                        <label for="signupName">Nombre</label>
                        <input 
                            type="text" 
                            id="signupName" 
                            class="form-input" 
                            placeholder="Tu nombre"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input 
                            type="email" 
                            id="signupEmail" 
                            class="form-input" 
                            placeholder="tu@email.com"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPassword">Contrase√±a</label>
                        <input 
                            type="password" 
                            id="signupPassword" 
                            class="form-input" 
                            placeholder="M√≠nimo 6 caracteres"
                            required
                            minlength="6"
                        >
                    </div>
                    
                    <button type="submit" class="btn-primary btn-block">
                        Crear Cuenta
                    </button>
                </form>
                
                <p class="auth-switch">
                    ¬øYa tienes cuenta? 
                    <a href="#" onclick="switchToLogin(); return false;">Inicia sesi√≥n</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="/privacy.html" class="footer-link">Privacy Policy</a>
                <a href="/terms.html" class="footer-link">Terms of Service</a>
                <a href="/cdn-cgi/l/email-protection#d3bfb6b4b2bf93bea6a0bab0a7bcb8b6bda1babdb4fdabaaa9" class="footer-link">Contact</a>
            </div>
            <p class="footer-copyright">
                ¬© 2026 MusicToken Ring. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Scripts -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="./auth-system.js"></script>
    <script src="./game-engine.js"></script>
    <script src="./src/app.js"></script>

    <script>
        // Variables globales
        let selectedSong = null;
        let currentMode = null;

        // Verificar login al cargar
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                showModeSelector();
                // Inicializar GameEngine
                if (typeof GameEngine !== 'undefined') {
                    await GameEngine.init();
                }
            } else {
                showLoginWall();
            }
        });

        // Mostrar/ocultar secciones
        function showLoginWall() {
            document.getElementById('loginWall').classList.remove('hidden');
            document.getElementById('modeSelector').classList.add('hidden');
        }

        function showModeSelector() {
            document.getElementById('loginWall').classList.add('hidden');
            document.getElementById('modeSelector').classList.remove('hidden');
        }

        // Seleccionar modo
        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeSelector').classList.add('hidden');
            document.getElementById('songSelection').classList.remove('hidden');
            
            const titles = {
                'quick': 'Modo R√°pido',
                'private': 'Sala Privada',
                'practice': 'Modo Pr√°ctica'
            };
            document.getElementById('modeTitle').textContent = titles[mode];
            
            updateActionButtons(mode);
        }

        function backToModes() {
            document.getElementById('songSelection').classList.add('hidden');
            document.getElementById('modeSelector').classList.remove('hidden');
            selectedSong = null;
        }

        // Actualizar botones seg√∫n modo
        function updateActionButtons(mode) {
            const buttonsDiv = document.getElementById('actionButtons');
            
            if (mode === 'quick') {
                buttonsDiv.innerHTML = `
                    <button onclick="startQuickMatch()" class="btn-primary btn-large" id="startQuickBtn" disabled>
                        ‚öîÔ∏è Buscar Rival
                    </button>
                `;
            } else if (mode === 'private') {
                buttonsDiv.innerHTML = `
                    <button onclick="createRoom()" class="btn-primary" id="createRoomBtn" disabled>
                        üé™ Crear Sala
                    </button>
                    <div class="or-divider">o</div>
                    <div class="join-room-group">
                        <input type="text" id="joinRoomCode" placeholder="C√≥digo" class="room-code-input" maxlength="6">
                        <button onclick="joinRoom()" class="btn-secondary" id="joinRoomBtn" disabled>
                            Unirse
                        </button>
                    </div>
                `;
            } else if (mode === 'practice') {
                buttonsDiv.innerHTML = `
                    <button onclick="startPractice()" class="btn-primary btn-large" id="startPracticeBtn" disabled>
                        üéØ Iniciar Pr√°ctica
                    </button>
                `;
            }
        }

        // B√∫squeda de canciones
        function searchSong() {
            const query = document.getElementById('songSearch').value;
            if (query.trim()) {
                searchDeezer(query, 'searchResults');
            }
        }

        // Seleccionar canci√≥n
        function selectSongForBattle(song) {
            selectedSong = song;
            
            const cardDiv = document.getElementById('selectedSongCard');
            cardDiv.innerHTML = `
                <img src="${song.image}" alt="${song.name}" class="selected-song-image">
                <div class="selected-song-info">
                    <h4>${song.name}</h4>
                    <p>${song.artist}</p>
                </div>
            `;
            
            // Habilitar botones
            document.querySelectorAll('#actionButtons button').forEach(btn => {
                if (!btn.classList.contains('btn-disabled')) {
                    btn.disabled = false;
                }
            });
        }

        // Apuesta r√°pida
        function quickBet(amount) {
            document.getElementById('betAmount').value = amount;
        }

        // Iniciar seg√∫n modo
        async function startQuickMatch() {
            if (!selectedSong) return;
            const bet = parseInt(document.getElementById('betAmount').value) || 100;
            if (typeof GameEngine !== 'undefined') {
                await GameEngine.joinQuickMatch(selectedSong, bet);
            } else {
                showToast('GameEngine no est√° cargado', 'error');
            }
        }

        async function createRoom() {
            if (!selectedSong) return;
            const bet = parseInt(document.getElementById('betAmount').value) || 100;
            if (typeof GameEngine !== 'undefined') {
                await GameEngine.createPrivateRoom(selectedSong, bet);
            } else {
                showToast('GameEngine no est√° cargado', 'error');
            }
        }

        async function joinRoom() {
            if (!selectedSong) return;
            const roomCode = document.getElementById('joinRoomCode').value.toUpperCase();
            const bet = parseInt(document.getElementById('betAmount').value) || 100;
            if (typeof GameEngine !== 'undefined') {
                await GameEngine.joinPrivateRoom(roomCode, selectedSong, bet);
            } else {
                showToast('GameEngine no est√° cargado', 'error');
            }
        }

        async function startPractice() {
            if (!selectedSong) {
                showToast('Selecciona una canci√≥n primero', 'error');
                return;
            }

            if (typeof GameEngine !== 'undefined') {
                await GameEngine.startPracticeMatch(selectedSong);
            } else {
                showToast('Modo pr√°ctica en desarrollo', 'info');
            }
        }

        function cancelSearch() {
            if (typeof GameEngine !== 'undefined' && typeof GameEngine.cancelMatchmaking === 'function') {
                GameEngine.cancelMatchmaking();
            } else {
                backToModes();
            }
        }

        function leaveRoom() {
            if (typeof GameEngine !== 'undefined' && typeof GameEngine.leavePrivateRoom === 'function') {
                GameEngine.leavePrivateRoom();
            } else {
                backToModes();
            }
        }

        function copyRoomCode() {
            const code = document.getElementById('roomCode').textContent;
            navigator.clipboard.writeText(code);
            if (typeof showToast !== 'undefined') {
                showToast('C√≥digo copiado', 'success');
            }
        }
    </script>
</body>
</html>
