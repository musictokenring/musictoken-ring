<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicToken Ring - Music Battle Arena</title>
   
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
   
    <!-- Styles -->
    <link rel="stylesheet" href="./styles/main.css">
   
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•ä</text></svg>">

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const CONFIG = {
            SUPABASE_URL: 'https://bscmgcnynbxalcuwdqlm.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzY21nY255bmJ4YWxjdXdkcWxtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTYwOTUsImV4cCI6MjA4NjAzMjA5NX0.1iasFQ5H0GmrFqi6poWNE1aZOtbmQuB113RCyg2BBK4',
            BATTLE_DURATION: 60,
            BACKEND_API: 'https://musictoken-backend.onrender.com'
        };
        function extractMetaMaskErrorMessage(reason) {
            if (!reason) return '';
            const direct = String(reason?.message || reason || '');
            const cause = String(reason?.cause?.message || '');
            return `${direct} ${cause}`.toLowerCase();
        }

        function isMetaMaskUnavailableError(reason) {
            const message = extractMetaMaskErrorMessage(reason);
            return message.includes('metamask extension not found') ||
                message.includes('failed to connect to metamask');
        }

        window.addEventListener('unhandledrejection', (event) => {
            if (!isMetaMaskUnavailableError(event.reason)) return;
            event.preventDefault();
            console.warn('MetaMask no est√° disponible en este navegador.');
            if (typeof showToast === 'function') {
                showToast('MetaMask no est√° disponible. Instala la extensi√≥n para conectar tu wallet.', 'error');
            }
        });

        const PLATFORM_WALLET_ADDRESSES = {
            polygon: '0x75376BC58830f27415402875D26B73A6BE8E2253',
            optimism: '0x75376BC58830f27415402875D26B73A6BE8E2253',
            base: '0x75376BC58830f27415402875D26B73A6BE8E2253',
            bnb: '0x75376BC58830f27415402875D26B73A6BE8E2253',
            arbitrum: '0x75376BC58830f27415402875D26B73A6BE8E2253',
            linea: '0x75376BC58830f27415402875D26B73A6BE8E2253',
            ethereum: '0x75376BC58830f27415402875D26B73A6BE8E2253',
            tron: 'TQMKLv12VA2kt2xH1edWNnQjgFGuzaLcVj',
            solana: 'AavRs1c4CmBDcJ2KzTh5C8btwbLv7CnCRbA6EpEJqaNr',
            bitcoin: 'bc1qtjwwj5lwsn4r5pjg8l30r4s5p843g4p344tr6a'
        };
        console.log('üéµ MusicToken Ring loaded!');
    </script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ü•ä</span>
                    <span class="logo-text">MusicToken Ring</span>
                </div>
                <h2 class="slogan">Music Token Ring ‚Äì The Wall Street of Beats</h2>
                
                <div class="header-badges">
                    <span class="badge">üéµ Deezer</span>
                    <span class="badge badge-live">üî¥ Live</span>
                    <span class="badge" id="balanceDisplay">üí∞ 0 $MTOKEN</span>
                </div>

                <div class="wallet-section">
                    <button onclick="connectWallet()" class="btn-secondary btn-wallet">
                        ü¶ä Conectar Wallet
                    </button>
                    <span id="walletAddress" class="wallet-address hidden"></span>
                </div>
                
                <!-- AUTH BUTTON -->
                <div id="authButton">
                    <button onclick="openAuthModal()" class="btn-login">
                        Iniciar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <section id="streamDashboard" class="stream-dashboard">
                <div class="stream-dashboard-header">
                    <h2>üìà Wall Street of Beats</h2>
                    <p>Top streams por regi√≥n (√∫ltimos 5 min)</p>
                </div>
                <div class="stream-region-tabs">
                    <button class="stream-region-tab active" data-region="latam" onclick="setDashboardRegion('latam')">Latam</button>
                    <button class="stream-region-tab" data-region="us" onclick="setDashboardRegion('us')">US</button>
                    <button class="stream-region-tab" data-region="eu" onclick="setDashboardRegion('eu')">EU</button>
                </div>
                <div class="stream-carousel-wrap">
                    <button class="stream-carousel-nav" onclick="moveDashboardCarousel(-1)">‚Äπ</button>
                    <div id="streamDashboardTrackList" class="stream-carousel-track">
                        <article class="stream-card">
                            <img src="https://e-cdns-images.dzcdn.net/images/cover/9f4c9025e2f4f4be85a8d0f95f3bc5fe/250x250-000000-80-0-0.jpg" alt="Luna">
                            <div class="stream-card-info">
                                <strong>Luna</strong>
                                <span>Feid</span>
                                <span class="stream-delta neutral">‚Ä¢ 34.1% del top</span>
                            </div>
                        </article>
                        <article class="stream-card">
                            <img src="https://e-cdns-images.dzcdn.net/images/cover/4aa4b9f4674f7f9f7428962456f31cc7/250x250-000000-80-0-0.jpg" alt="Si Antes Te Hubiera Conocido">
                            <div class="stream-card-info">
                                <strong>Si Antes Te Hubiera Conocido</strong>
                                <span>KAROL G</span>
                                <span class="stream-delta neutral">‚Ä¢ 33.0% del top</span>
                            </div>
                        </article>
                        <article class="stream-card">
                            <img src="https://e-cdns-images.dzcdn.net/images/cover/236f9df9f6f95cc8c6f0707dbe6839df/250x250-000000-80-0-0.jpg" alt="Perro Negro">
                            <div class="stream-card-info">
                                <strong>Perro Negro</strong>
                                <span>Bad Bunny</span>
                                <span class="stream-delta neutral">‚Ä¢ 33.3% del top</span>
                            </div>
                        </article>
                    </div>
                    <button class="stream-carousel-nav" onclick="moveDashboardCarousel(1)">‚Ä∫</button>
                </div>
            </section>
            
            <!-- LOGIN WALL (mostrar si no est√° logueado) -->
            <section id="loginWall" class="login-wall">
                <div class="login-wall-content">
                    <div class="login-wall-icon">ü•ä</div>
                    <h1 class="login-wall-title">Bienvenido a MusicToken Ring</h1>
                    <p class="login-wall-subtitle">
                        Batalla con tus canciones favoritas, apuesta $MTOKEN y demuestra qui√©n tiene mejor gusto musical
                    </p>
                    <button onclick="openAuthModal()" class="btn-primary btn-large">
                        Iniciar Sesi√≥n para Jugar
                    </button>
                    <div class="login-wall-features">
                        <div class="feature-item">
                            <span class="feature-icon">‚öîÔ∏è</span>
                            <span class="feature-text">Modo R√°pido</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üé™</span>
                            <span class="feature-text">Salas Privadas</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üèÜ</span>
                            <span class="feature-text">Torneos</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üéØ</span>
                            <span class="feature-text">Modo Pr√°ctica</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="streaming-showcase">
                <p class="streaming-label">Streaming partners</p>
                <div class="streaming-logos">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/deezer.svg" alt="Deezer" class="streaming-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/spotify.svg" alt="Spotify" class="streaming-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/applemusic.svg" alt="Apple Music" class="streaming-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/youtubemusic.svg" alt="YouTube Music" class="streaming-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/amazonmusic.svg" alt="Amazon Music" class="streaming-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/tidal.svg" alt="Tidal" class="streaming-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/soundcloud.svg" alt="SoundCloud" class="streaming-logo" onerror="this.style.display='none'">
                </div>
            </section>

            <section class="payments-showcase">
                <p class="streaming-label">Redes y monedas soportadas para pagos</p>
                <div class="payment-controls">
                    <label for="preferredNetwork" class="payment-label">Red preferida para comisiones</label>
                    <select id="preferredNetwork" class="payment-select" onchange="setPreferredNetwork(this.value)"></select>
                </div>
                <div class="currency-logos">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/polygon.svg" alt="Polygon" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/ethereum.svg" alt="Ethereum" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/optimism.svg" alt="Optimism" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/base.svg" alt="Base" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/bnbchain.svg" alt="BNB Chain" class="currency-logo" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/binance.svg';">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/arbitrum.svg" alt="Arbitrum" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/linea.svg" alt="Linea" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/tron.svg" alt="Tron" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/solana.svg" alt="Solana" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/bitcoin.svg" alt="Bitcoin" class="currency-logo" onerror="this.style.display='none'">
                </div>
                <div class="wallet-directory" id="walletDirectory"></div>

                <div class="settlement-panel">
                    <div class="settlement-card">
                        <h4>Recarga verificable (on-chain ‚Üí saldo)</h4>
                        <p class="settlement-help">
                            Env√≠a tus tokens a la wallet de la red seleccionada y pega el hash de transacci√≥n para validarlo con el backend.
                        </p>
                        <div class="settlement-grid">
                            <input id="depositTxHash" class="payment-input" type="text" placeholder="0x... hash de transacci√≥n">
                            <input id="depositAmount" class="payment-input" type="number" min="1" placeholder="Monto enviado (opcional)">
                        </div>
                        <button class="btn-secondary" onclick="verifyDepositTx()">‚úÖ Verificar y acreditar recarga</button>
                    </div>

                    <div class="settlement-card">
                        <h4>Liquidaci√≥n de ganancias (MTOKEN ‚Üí USD digital)</h4>
                        <p class="settlement-help">
                            Solicita retiro cuando tengas saldo. El backend cotiza con referencia USD y registra la comisi√≥n antes de liquidar.
                        </p>
                        <div class="settlement-grid">
                            <input id="cashoutAmount" class="payment-input" type="number" min="1" placeholder="MTOKEN a retirar">
                            <button class="btn-secondary" onclick="quoteCashout()">üìä Cotizar en USD</button>
                        </div>
                        <p class="settlement-quote" id="cashoutQuote">Sin cotizaci√≥n a√∫n.</p>
                        <button class="btn-primary" onclick="requestCashout()">üí∏ Solicitar retiro</button>
                    </div>
                </div>
            </section>

            <!-- SELECTOR DE MODO (mostrar si est√° logueado) -->
            <section id="modeSelector" class="mode-selector hidden">
                <div class="section-header">
                    <h1 class="section-title">Elige tu Modo de Juego</h1>
                    <p class="section-subtitle">Selecciona c√≥mo quieres competir</p>
                </div>

                <div class="modes-grid">
                    <!-- Modo R√°pido -->
                    <div class="mode-card" onclick="event.stopPropagation(); selectMode('quick');">
                        <div class="mode-icon">‚öîÔ∏è</div>
                        <h3 class="mode-title">Modo R√°pido</h3>
                        <p class="mode-description">
                            Matchmaking autom√°tico. Encuentra un rival en segundos y empieza a batallar.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üéØ Emparejamiento autom√°tico</span>
                            <span class="mode-feature">üí∞ Apuesta personalizada</span>
                            <span class="mode-feature">‚è±Ô∏è Partidas de 1 minuto</span>
                        </div>
                        <button class="btn-mode" onclick="event.stopPropagation(); selectMode('quick');">Jugar Ahora</button>
                    </div>

                    <!-- Sala Privada -->
                    <div class="mode-card" onclick="event.stopPropagation(); selectMode('private');">
                        <div class="mode-icon">üé™</div>
                        <h3 class="mode-title">Sala Privada</h3>
                        <p class="mode-description">
                            Crea una sala e invita a tus amigos. Personaliza las reglas y apuestas.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üë• Juega con amigos</span>
                            <span class="mode-feature">üîó C√≥digo de sala √∫nico</span>
                            <span class="mode-feature">‚öôÔ∏è Reglas personalizadas</span>
                        </div>
                        <button class="btn-mode" onclick="event.stopPropagation(); selectMode('private');">Crear Sala</button>
                    </div>

                    <!-- Torneo -->
                    <div class="mode-card" onclick="event.stopPropagation(); selectMode('tournament');">
                        <div class="mode-icon">üèÜ</div>
                        <h3 class="mode-title">Torneo</h3>
                        <p class="mode-description">
                            Compite en torneos de eliminaci√≥n. Gana premios masivos del prize pool.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üé™ M√∫ltiples rondas</span>
                            <span class="mode-feature">üíé Grandes premios</span>
                            <span class="mode-feature">üèÖ Rankings globales</span>
                        </div>
                        <button class="btn-mode" onclick="event.stopPropagation(); selectMode('tournament');">Unirse al Torneo</button>
                    </div>

                    <!-- Modo Pr√°ctica -->
                    <div class="mode-card" onclick="event.stopPropagation(); selectMode('practice');">
                        <div class="mode-icon">üéØ</div>
                        <h3 class="mode-title">Modo Pr√°ctica</h3>
                        <p class="mode-description">
                            Practica contra la CPU sin arriesgar tokens. Perfecto para nuevos jugadores.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üéÆ Sin riesgo</span>
                            <span class="mode-feature">üéÅ Peque√±as recompensas</span>
                            <span class="mode-feature">üìö Aprende a jugar</span>
                        </div>
                        <button class="btn-mode" onclick="event.stopPropagation(); selectMode('practice');">Practicar</button>
                    </div>
                </div>
            </section>

            <!-- SELECCI√ìN DE CANCI√ìN Y APUESTA -->
            <section id="songSelection" class="hidden">
                <div class="section-header">
                    <button onclick="backToModes()" class="btn-back">‚Üê Volver</button>
                    <h2 class="section-title" id="modeTitle">Modo R√°pido</h2>
                    <p class="section-subtitle">Elige tu canci√≥n y realiza tu apuesta</p>
                </div>

                <div class="selection-container">
                    <!-- B√∫squeda -->
                    <div class="search-panel">
                        <h3>üéµ Busca tu Canci√≥n</h3>
                        <div class="search-box">
                            <input 
                                type="text" 
                                id="songSearch" 
                                placeholder="Nombre de canci√≥n o artista..."
                                class="search-input"
                            >
                            <button onclick="searchSong()" class="search-btn">üîç</button>
                        </div>

                        <!-- Resultados -->
                        <div id="searchResults" class="results-grid"></div>
                    </div>

                    <!-- Selecci√≥n Actual y Apuesta -->
                    <div class="bet-panel">
                        <div class="selected-song" id="selectedSongCard">
                            <div class="no-selection">
                                <div class="no-selection-icon">üéµ</div>
                                <p>Selecciona una canci√≥n</p>
                            </div>
                        </div>

                        <div class="bet-section">
                            <h3>üí∞ Tu Apuesta</h3>
                            <div class="bet-info">
                                <span><span id="balanceLabel">Balance</span>: <strong id="userBalance">0</strong> $MTOKEN</span>
                                <span>M√≠nimo: <strong id="minBet">100</strong> $MTOKEN</span>
                            </div>
                            <input 
                                type="number" 
                                id="betAmount" 
                                placeholder="100" 
                                min="100" 
                                class="bet-input"
                            >
                            <div class="bet-quick">
                                <button onclick="quickBet(100)" class="btn-quick">100</button>
                                <button onclick="quickBet(500)" class="btn-quick">500</button>
                                <button onclick="quickBet(1000)" class="btn-quick">1K</button>
                                <button onclick="quickBet(5000)" class="btn-quick">5K</button>
                            </div>

                            <!-- Botones seg√∫n modo -->
                            <div id="actionButtons"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PANTALLA DE ESPERA -->
            <section id="waitingScreen" class="hidden">
                <div class="waiting-content">
                    <div class="waiting-spinner">‚è≥</div>
                    <h2 class="waiting-title">Buscando Oponente...</h2>
                    <p class="waiting-subtitle">Esto puede tomar unos segundos</p>
                    <button onclick="cancelSearch()" class="btn-secondary">Cancelar B√∫squeda</button>
                </div>
            </section>

            <!-- PANTALLA DE SALA PRIVADA -->
            <section id="roomScreen" class="hidden">
                <div class="room-content">
                    <div class="room-header">
                        <h2>üé™ Sala Privada</h2>
                        <div class="room-code-display">
                            <span>C√≥digo:</span>
                            <strong id="roomCode">XXXXX</strong>
                            <button onclick="copyRoomCode()" class="btn-copy">üìã</button>
                        </div>
                    </div>
                    <div class="room-invite">
                        <label for="roomInviteLink">Link privado para invitar</label>
                        <div class="room-invite-actions">
                            <input id="roomInviteLink" type="text" readonly class="room-invite-input">
                            <button onclick="copyRoomLink()" class="btn-secondary">Copiar link</button>
                        </div>
                    </div>
                    <div class="room-players">
                        <div class="room-player" id="player1Card">
                            <div class="player-avatar">üë§</div>
                            <span class="player-name">Esperando...</span>
                        </div>
                        <div class="room-vs">VS</div>
                        <div class="room-player" id="player2Card">
                            <div class="player-avatar">‚ùì</div>
                            <span class="player-name">Esperando rival...</span>
                        </div>
                    </div>
                    <p class="room-info">Comparte el c√≥digo con tu amigo</p>
                    <button onclick="leaveRoom()" class="btn-secondary">Salir de la Sala</button>
                </div>
            </section>

        </div>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal hidden">
        <div class="modal-overlay" onclick="closeAuthModal()"></div>
        <div class="modal-content auth-modal-content">
            <button onclick="closeAuthModal()" class="modal-close">√ó</button>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <h2 class="auth-title">Iniciar Sesi√≥n</h2>
                <p class="auth-subtitle">Accede a tu cuenta para guardar tu progreso</p>
                
                <!-- Google Login -->
                <button onclick="loginWithGoogle()" class="btn-google">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/>
                        <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                        <path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/>
                        <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                    </svg>
                    Continuar con Google
                </button>
                
                <div class="auth-divider">
                    <span>o</span>
                </div>
                
                <!-- Email Login -->
                <form onsubmit="handleLoginSubmit(event)">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input 
                            type="email" 
                            id="loginEmail" 
                            class="form-input" 
                            placeholder="tu@email.com"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">Contrase√±a</label>
                        <input 
                            type="password" 
                            id="loginPassword" 
                            class="form-input" 
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                        >
                    </div>
                    
                    <button type="submit" class="btn-primary btn-block">
                        Iniciar Sesi√≥n
                    </button>
                </form>
                
                <p class="auth-switch">
                    ¬øNo tienes cuenta? 
                    <a href="#" onclick="switchToSignup(); return false;">Reg√≠strate</a>
                </p>
            </div>
            
            <!-- Signup Form -->
            <div id="signupForm" class="auth-form hidden">
                <h2 class="auth-title">Crear Cuenta</h2>
                <p class="auth-subtitle">√önete a MusicToken Ring</p>
                
                <!-- Google Signup -->
                <button onclick="loginWithGoogle()" class="btn-google">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/>
                        <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                        <path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/>
                        <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                    </svg>
                    Continuar con Google
                </button>
                
                <div class="auth-divider">
                    <span>o</span>
                </div>
                
                <!-- Email Signup -->
                <form onsubmit="handleSignupSubmit(event)">
                    <div class="form-group">
                        <label for="signupName">Nombre</label>
                        <input 
                            type="text" 
                            id="signupName" 
                            class="form-input" 
                            placeholder="Tu nombre"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input 
                            type="email" 
                            id="signupEmail" 
                            class="form-input" 
                            placeholder="tu@email.com"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPassword">Contrase√±a</label>
                        <input 
                            type="password" 
                            id="signupPassword" 
                            class="form-input" 
                            placeholder="M√≠nimo 6 caracteres"
                            required
                            minlength="6"
                        >
                    </div>
                    
                    <button type="submit" class="btn-primary btn-block">
                        Crear Cuenta
                    </button>
                </form>
                
                <p class="auth-switch">
                    ¬øYa tienes cuenta? 
                    <a href="#" onclick="switchToLogin(); return false;">Inicia sesi√≥n</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Player Profile Modal -->
    <div id="profileModal" class="modal hidden">
        <div class="modal-overlay" onclick="closeProfileModal()"></div>
        <div class="modal-content profile-modal-content">
            <button onclick="closeProfileModal()" class="modal-close">√ó</button>
            <h2 class="auth-title">Perfil del Jugador</h2>
            <p class="auth-subtitle">Resumen de rendimiento y actividad reciente</p>

            <div class="profile-header">
                <p id="profileDisplayName" class="profile-name">Jugador</p>
                <p id="profileEmail" class="profile-email">-</p>
                <p class="profile-since">Miembro desde: <span id="profileSince">-</span></p>
            </div>

            <div class="profile-stats-grid">
                <div class="profile-stat-card"><span>Balance</span><strong id="profileBalance">-</strong></div>
                <div class="profile-stat-card"><span>Partidas</span><strong id="profileMatches">-</strong></div>
                <div class="profile-stat-card"><span>Victorias</span><strong id="profileWins">-</strong></div>
                <div class="profile-stat-card"><span>Derrotas</span><strong id="profileLosses">-</strong></div>
                <div class="profile-stat-card"><span>Win Rate</span><strong id="profileWinRate">-</strong></div>
                <div class="profile-stat-card"><span>Streams totales</span><strong id="profileStreams">-</strong></div>
                <div class="profile-stat-card full"><span>MTOKEN apostados</span><strong id="profileWagered">-</strong></div>
            </div>

            <div class="profile-recent-section">
                <h3>√öltimas partidas</h3>
                <div id="profileRecentMatches" class="profile-recent-list">
                    <p class="profile-empty">Sin partidas a√∫n.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Match Challenge Modal -->
    <div id="challengeModal" class="modal hidden">
        <div class="modal-overlay" onclick="closeChallengeModal()"></div>
        <div class="modal-content">
            <button onclick="closeChallengeModal()" class="modal-close">√ó</button>
            <h2 class="auth-title">‚öîÔ∏è Reto R√°pido</h2>
            <p class="auth-subtitle" id="challengeDetails">Tienes un reto pendiente</p>
            <div class="challenge-actions">
                <button onclick="acceptChallenge()" class="btn-primary btn-block">Aceptar</button>
                <button onclick="rejectChallenge()" class="btn-secondary btn-block">Rechazar</button>
            </div>
        </div>
    </div>

    <!-- Contacto -->
    <section id="contactSection" class="contact-section">
        <div class="contact-card">
            <h2>Contacto</h2>
            <p>¬øTienes dudas o necesitas ayuda? Escr√≠benos a <a href="mailto:support@musictokenring.xyz">support@musictokenring.xyz</a>.</p>
            <form class="contact-form" onsubmit="submitContactForm(event)">
                <div class="form-group">
                    <label for="contactName">Nombre</label>
                    <input type="text" id="contactName" class="form-input" placeholder="Tu nombre" required>
                </div>
                <div class="form-group">
                    <label for="contactEmail">Email</label>
                    <input type="email" id="contactEmail" class="form-input" placeholder="tu@email.com" required>
                </div>
                <div class="form-group">
                    <label for="contactMessage">Mensaje</label>
                    <textarea id="contactMessage" class="form-input" rows="4" placeholder="Cu√©ntanos en qu√© podemos ayudarte" required></textarea>
                </div>
                <button type="submit" class="btn-primary">Enviar mensaje</button>
            </form>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="/privacy.html" class="footer-link">Privacy Policy</a>
                <a href="/terms.html" class="footer-link">Terms of Service</a>
                <a href="#contactSection" class="footer-link">Contact</a>
            </div>
            <p class="footer-copyright">
                ¬© 2026 MusicToken Ring. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="./auth-system.js"></script>
    <script src="./game-engine.js"></script>
    <script src="./src/top-streams-fallback.js?v=20260216c"></script>
    <script src="./src/app.js?v=20260216g"></script>

    <script>
        // Variables globales
        let selectedSong = null;
        let currentMode = null;


        function ensureTopStreamsFallbackVisible() {
            const list = document.getElementById('streamDashboardTrackList');
            if (!list) return;
            if (list.querySelector('.stream-card')) return;

            list.innerHTML = `
                <article class="stream-card">
                    <img src="https://e-cdns-images.dzcdn.net/images/cover/9f4c9025e2f4f4be85a8d0f95f3bc5fe/250x250-000000-80-0-0.jpg" alt="Luna">
                    <div class="stream-card-info">
                        <strong>Luna</strong>
                        <span>Feid</span>
                        <span class="stream-delta neutral">‚Ä¢ 33.3% del top</span>
                    </div>
                </article>
                <article class="stream-card">
                    <img src="https://e-cdns-images.dzcdn.net/images/cover/4aa4b9f4674f7f9f7428962456f31cc7/250x250-000000-80-0-0.jpg" alt="Si Antes Te Hubiera Conocido">
                    <div class="stream-card-info">
                        <strong>Si Antes Te Hubiera Conocido</strong>
                        <span>KAROL G</span>
                        <span class="stream-delta neutral">‚Ä¢ 33.3% del top</span>
                    </div>
                </article>
                <article class="stream-card">
                    <img src="https://e-cdns-images.dzcdn.net/images/cover/236f9df9f6f95cc8c6f0707dbe6839df/250x250-000000-80-0-0.jpg" alt="Perro Negro">
                    <div class="stream-card-info">
                        <strong>Perro Negro</strong>
                        <span>Bad Bunny</span>
                        <span class="stream-delta neutral">‚Ä¢ 33.3% del top</span>
                    </div>
                </article>
            `;
        }

        // Verificar login al cargar
        document.addEventListener('DOMContentLoaded', async () => {
            ensureTopStreamsFallbackVisible();
            initializePreferredNetwork();
            renderWalletDirectory();

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (session) {
                    showModeSelector();
                    // Inicializar GameEngine
                    if (typeof GameEngine !== 'undefined') {
                        await GameEngine.init();
                    }
                } else {
                    showLoginWall();
                }

                const urlParams = new URLSearchParams(window.location.search);
                const modeParam = urlParams.get('mode');
                if (modeParam && ['quick', 'private', 'practice', 'tournament'].includes(modeParam)) {
                    selectMode(modeParam);
                    if (modeParam === 'practice') {
                        showToast('Elige otra canci√≥n para continuar en pr√°ctica.', 'info');
                    }
                }

                const roomParam = urlParams.get('room');
                if (roomParam) {
                    selectMode('private');
                    document.getElementById('joinRoomCode').value = roomParam.toUpperCase();
                    showToast('Sala privada detectada. Selecciona tu canci√≥n para unirte.', 'info');
                }
            } catch (error) {
                console.error('Error inicializando sesi√≥n:', error);
                showLoginWall();
            }
        });

        // Mostrar/ocultar secciones
        function showLoginWall() {
            document.getElementById('loginWall').classList.remove('hidden');
            document.getElementById('modeSelector').classList.add('hidden');
        }

        function showModeSelector() {
            document.getElementById('loginWall').classList.add('hidden');
            document.getElementById('modeSelector').classList.remove('hidden');
        }

        function initializePreferredNetwork() {
            const selector = document.getElementById('preferredNetwork');
            if (!selector || typeof PLATFORM_WALLET_ADDRESSES === 'undefined') return;

            const stored = localStorage.getItem('mtr_preferred_network') || 'polygon';
            const options = Object.keys(PLATFORM_WALLET_ADDRESSES).map((network) => {
                const label = network.charAt(0).toUpperCase() + network.slice(1);
                const selected = network === stored ? 'selected' : '';
                return `<option value="${network}" ${selected}>${label}</option>`;
            }).join('');

            selector.innerHTML = options;
            localStorage.setItem('mtr_preferred_network', selector.value || stored);
        }

        function setPreferredNetwork(network) {
            localStorage.setItem('mtr_preferred_network', network);
            renderWalletDirectory(network);
            showToast(`Red preferida actualizada: ${network.toUpperCase()}`, 'success');
        }

        function submitContactForm(event) {
            event.preventDefault();
            const name = document.getElementById('contactName').value.trim();
            const email = document.getElementById('contactEmail').value.trim();
            const message = document.getElementById('contactMessage').value.trim();
            const subject = encodeURIComponent(`Soporte MusicToken Ring - ${name}`);
            const body = encodeURIComponent(`Nombre: ${name}\nEmail: ${email}\n\nMensaje:\n${message}`);
            window.location.href = `mailto:support@musictokenring.xyz?subject=${subject}&body=${body}`;
            showToast('Abriendo tu cliente de correo para enviar el mensaje.', 'success');
        }

        function copyWalletAddress(address, network) {
            navigator.clipboard.writeText(address);
            showToast(`Direcci√≥n de ${network.toUpperCase()} copiada`, 'success');
        }

        function renderWalletDirectory(selectedNetwork = null) {
            const walletDirectory = document.getElementById('walletDirectory');
            if (!walletDirectory || typeof PLATFORM_WALLET_ADDRESSES === 'undefined') return;

            const selector = document.getElementById('preferredNetwork');
            const activeNetwork = selectedNetwork || selector?.value || localStorage.getItem('mtr_preferred_network') || 'polygon';
            const selectedAddress = PLATFORM_WALLET_ADDRESSES[activeNetwork];

            if (!selectedAddress) {
                walletDirectory.innerHTML = '<div class="wallet-item"><span class="wallet-network">Sin red seleccionada</span></div>';
                return;
            }

            const label = activeNetwork.charAt(0).toUpperCase() + activeNetwork.slice(1);
            walletDirectory.innerHTML = `
                <div class="wallet-item">
                    <span class="wallet-network">${label}</span>
                    <span class="wallet-value">${selectedAddress}</span>
                    <button class="wallet-copy" onclick="copyWalletAddress('${selectedAddress}', '${activeNetwork}')">Copiar</button>
                </div>
            `;
        }

        // Seleccionar modo
        function selectMode(mode) {
            currentMode = mode;
            window.currentMode = mode;
            document.getElementById('modeSelector').classList.add('hidden');
            document.getElementById('songSelection').classList.remove('hidden');
            
            const titles = {
                'quick': 'Modo R√°pido',
                'private': 'Sala Privada',
                'practice': 'Modo Pr√°ctica',
                'tournament': 'Modo Torneo'
            };
            document.getElementById('modeTitle').textContent = titles[mode];
            
            updateActionButtons(mode);
            if (typeof GameEngine !== 'undefined' && typeof GameEngine.updatePracticeBetDisplay === 'function') {
                GameEngine.updatePracticeBetDisplay();
            }
        }

        function backToModes() {
            document.getElementById('songSelection').classList.add('hidden');
            document.getElementById('modeSelector').classList.remove('hidden');
            window.currentMode = null;
            if (typeof GameEngine !== 'undefined' && typeof GameEngine.updatePracticeBetDisplay === 'function') {
                GameEngine.updatePracticeBetDisplay();
            }
            selectedSong = null;
        }

        // Actualizar botones seg√∫n modo
        function updateActionButtons(mode) {
            const buttonsDiv = document.getElementById('actionButtons');
            
            if (mode === 'quick') {
                buttonsDiv.innerHTML = `
                    <button onclick="startQuickMatch()" class="btn-primary btn-large" id="startQuickBtn" disabled>
                        ‚öîÔ∏è Buscar Rival
                    </button>
                `;
            } else if (mode === 'private') {
                buttonsDiv.innerHTML = `
                    <button onclick="createRoom()" class="btn-primary" id="createRoomBtn" disabled>
                        üé™ Crear Sala
                    </button>
                    <div class="or-divider">o</div>
                    <div class="join-room-group">
                        <input type="text" id="joinRoomCode" placeholder="C√≥digo" class="room-code-input" maxlength="6">
                        <button onclick="joinRoom()" class="btn-secondary" id="joinRoomBtn" disabled>
                            Unirse
                        </button>
                    </div>
                `;
            } else if (mode === 'practice') {
                buttonsDiv.innerHTML = `
                    <button onclick="startPractice()" class="btn-primary btn-large" id="startPracticeBtn" disabled>
                        üéØ Iniciar Pr√°ctica
                    </button>
                `;
            } else if (mode === 'tournament') {
                buttonsDiv.innerHTML = `
                    <div class="join-room-group">
                        <input type="text" id="tournamentId" placeholder="ID de torneo" class="room-code-input">
                        <button onclick="joinTournamentMode()" class="btn-primary" id="joinTournamentBtn" disabled>
                            üèÜ Unirme
                        </button>
                    </div>
                    <p class="section-subtitle" style="margin-top: 12px;">
                        El jackpot crece con un % de las comisiones cuando la plataforma supera el 90% del objetivo.
                    </p>
                `;
            }
        }

        // B√∫squeda de canciones
        function searchSong() {
            const query = document.getElementById('songSearch').value;
            if (query.trim()) {
                searchDeezer(query, 'searchResults');
            }
        }

        // Seleccionar canci√≥n
        async function selectSongForBattle(song) {
            if (typeof GameEngine !== 'undefined' && typeof GameEngine.ensureSongEligibleForMatchmaking === 'function') {
                const eloGate = await GameEngine.ensureSongEligibleForMatchmaking(song.id);
                if (!eloGate.allowed) {
                    showToast(eloGate.reason || 'Canci√≥n fuera del rango ELO permitido', 'error');
                    return;
                }
            }
            selectedSong = song;
            
            const cardDiv = document.getElementById('selectedSongCard');
            cardDiv.innerHTML = `
                <img src="${song.image}" alt="${song.name}" class="selected-song-image">
                <div class="selected-song-info">
                    <h4>${song.name}</h4>
                    <p>${song.artist}</p>
                </div>
            `;
            
            // Habilitar botones
            document.querySelectorAll('#actionButtons button').forEach(btn => {
                if (!btn.classList.contains('btn-disabled')) {
                    btn.disabled = false;
                }
            });
        }

        // Apuesta r√°pida
        function quickBet(amount) {
            document.getElementById('betAmount').value = amount;
        }

        // Iniciar seg√∫n modo
        async function startQuickMatch() {
            if (!selectedSong) return;
            const bet = parseInt(document.getElementById('betAmount').value) || 100;
            if (typeof GameEngine !== 'undefined') {
                await GameEngine.joinQuickMatch(selectedSong, bet);
            } else {
                showToast('GameEngine no est√° cargado', 'error');
            }
        }

        async function createRoom() {
            if (!selectedSong) return;
            const bet = parseInt(document.getElementById('betAmount').value) || 100;
            if (typeof GameEngine !== 'undefined') {
                await GameEngine.createPrivateRoom(selectedSong, bet);
            } else {
                showToast('GameEngine no est√° cargado', 'error');
            }
        }

        async function joinRoom() {
            if (!selectedSong) return;
            const roomCode = document.getElementById('joinRoomCode').value.toUpperCase();
            const bet = parseInt(document.getElementById('betAmount').value) || 100;
            if (typeof GameEngine !== 'undefined') {
                await GameEngine.joinPrivateRoom(roomCode, selectedSong, bet);
            } else {
                showToast('GameEngine no est√° cargado', 'error');
            }
        }

        async function startPractice() {
            if (!selectedSong) {
                showToast('Selecciona una canci√≥n primero', 'error');
                return;
            }

            const demoBet = parseInt(document.getElementById('betAmount').value) || 100;

            if (typeof GameEngine !== 'undefined') {
                await GameEngine.startPracticeMatch(selectedSong, demoBet);
            } else {
                showToast('Modo pr√°ctica en desarrollo', 'info');
            }
        }

        async function joinTournamentMode() {
            if (!selectedSong) return;
            const tournamentId = document.getElementById('tournamentId').value;
            if (!tournamentId) {
                showToast('Ingresa el ID del torneo', 'error');
                return;
            }
            const bet = parseInt(document.getElementById('betAmount').value) || 100;
            if (typeof GameEngine !== 'undefined') {
                await GameEngine.joinTournament(tournamentId, selectedSong, bet);
            } else {
                showToast('Modo torneo en desarrollo', 'info');
            }
        }

        function cancelSearch() {
            if (typeof GameEngine !== 'undefined' && typeof GameEngine.cancelMatchmaking === 'function') {
                GameEngine.cancelMatchmaking();
            } else {
                backToModes();
            }
        }

        function leaveRoom() {
            if (typeof GameEngine !== 'undefined' && typeof GameEngine.leavePrivateRoom === 'function') {
                GameEngine.leavePrivateRoom();
            } else {
                backToModes();
            }
        }

        function copyRoomCode() {
            const code = document.getElementById('roomCode').textContent;
            navigator.clipboard.writeText(code);
            if (typeof showToast !== 'undefined') {
                showToast('C√≥digo copiado', 'success');
            }
        }

        function copyRoomLink() {
            const link = document.getElementById('roomInviteLink').value;
            navigator.clipboard.writeText(link);
            if (typeof showToast !== 'undefined') {
                showToast('Link copiado', 'success');
            }
        }

        function connectWallet() {
            if (typeof GameEngine !== 'undefined') {
                GameEngine.connectWallet();
            } else {
                showToast('GameEngine no est√° cargado', 'error');
            }
        }

        function showIncomingChallenge(challenge) {
            const modal = document.getElementById('challengeModal');
            const details = document.getElementById('challengeDetails');
            if (details) {
                details.textContent = `${challenge.song.name} - ${challenge.song.artist} | Apuesta: ${challenge.betAmount} $MTOKEN`;
            }
            modal.classList.remove('hidden');
        }

        function closeChallengeModal() {
            document.getElementById('challengeModal').classList.add('hidden');
        }

        function acceptChallenge() {
            closeChallengeModal();
            selectMode('quick');
            showToast('Reto aceptado. Selecciona tu canci√≥n para iniciar.', 'success');
        }

        function rejectChallenge() {
            if (typeof GameEngine !== 'undefined') {
                GameEngine.pendingChallenge = null;
            }
            closeChallengeModal();
            showToast('Reto rechazado', 'info');
        }

        async function verifyDepositTx() {
            const txHash = document.getElementById('depositTxHash')?.value?.trim();
            const expectedAmount = parseFloat(document.getElementById('depositAmount')?.value || '0');

            if (!txHash) {
                showToast('Ingresa el hash de la transacci√≥n', 'error');
                return;
            }

            if (typeof GameEngine === 'undefined') {
                showToast('GameEngine no est√° cargado', 'error');
                return;
            }

            const result = await GameEngine.verifyDepositAndCredit(txHash, {
                network: document.getElementById('preferredNetwork')?.value || 'polygon',
                expectedAmount: expectedAmount > 0 ? expectedAmount : undefined
            });

            if (result?.ok) {
                showToast(`Recarga acreditada: +${result.creditedAmount || result.amount || 0} $MTOKEN`, 'success');
            }
        }

        async function quoteCashout() {
            const amount = parseFloat(document.getElementById('cashoutAmount')?.value || '0');
            if (!amount || amount <= 0) {
                showToast('Ingresa un monto v√°lido', 'error');
                return;
            }
            if (typeof GameEngine === 'undefined') {
                showToast('GameEngine no est√° cargado', 'error');
                return;
            }

            const quote = await GameEngine.getUsdSettlementQuote(amount);
            const quoteEl = document.getElementById('cashoutQuote');
            if (quoteEl && quote) {
                quoteEl.textContent = `Referencia: 1 MTOKEN = $${quote.usdRate}. Neto estimado: $${quote.netUsd} (fee ${quote.feePercent}%).`;
            }
        }

        async function requestCashout() {
            const amount = parseFloat(document.getElementById('cashoutAmount')?.value || '0');
            if (!amount || amount <= 0) {
                showToast('Ingresa un monto v√°lido', 'error');
                return;
            }
            if (typeof GameEngine === 'undefined') {
                showToast('GameEngine no est√° cargado', 'error');
                return;
            }

            const payout = await GameEngine.requestCashout(amount, {
                network: document.getElementById('preferredNetwork')?.value || 'polygon'
            });

            if (payout?.ok) {
                showToast(`Retiro solicitado: ${payout.requestId || 'ID pendiente'}`, 'success');
            }
        }
        window.showIncomingChallenge = showIncomingChallenge;
    </script>
</body>
</html>
