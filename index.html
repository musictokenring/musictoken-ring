<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicToken Ring - Music Battle Arena</title>
   
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
   
    <!-- Styles -->
    <link rel="stylesheet" href="./styles/main.css">
   
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•ä</text></svg>">

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const CONFIG = {
            SUPABASE_URL: 'https://bscmgcnynbxalcuwdqlm.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzY21nY255bmJ4YWxjdXdkcWxtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTYwOTUsImV4cCI6MjA4NjAzMjA5NX0.1iasFQ5H0GmrFqi6poWNE1aZOtbmQuB113RCyg2BBK4',
            BATTLE_DURATION: 60
        };
        console.log('üéµ MusicToken Ring loaded!');
    </script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ü•ä</span>
                    <span class="logo-text">MusicToken Ring</span>
                </div>
                
                <div class="header-badges">
                    <span class="badge">üéµ Deezer</span>
                    <span class="badge badge-live">üî¥ Live</span>
                    <span class="badge" id="balanceDisplay">üí∞ 0 $MTOKEN</span>
                </div>
                
                <!-- AUTH BUTTON -->
                <div id="authButton">
                    <button onclick="openAuthModal()" class="btn-login">
                        Iniciar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            
            <!-- LOGIN WALL (mostrar si no est√° logueado) -->
            <section id="loginWall" class="login-wall">
                <div class="login-wall-content">
                    <div class="login-wall-icon">ü•ä</div>
                    <h1 class="login-wall-title">Bienvenido a MusicToken Ring</h1>
                    <p class="login-wall-subtitle">
                        Batalla con tus canciones favoritas, apuesta $MTOKEN y demuestra qui√©n tiene mejor gusto musical
                    </p>
                    <button onclick="openAuthModal()" class="btn-primary btn-large">
                        Iniciar Sesi√≥n para Jugar
                    </button>
                    <div class="login-wall-features">
                        <div class="feature-item">
                            <span class="feature-icon">‚öîÔ∏è</span>
                            <span class="feature-text">Modo R√°pido</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üé™</span>
                            <span class="feature-text">Salas Privadas</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üèÜ</span>
                            <span class="feature-text">Torneos</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üéØ</span>
                            <span class="feature-text">Modo Pr√°ctica</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SELECTOR DE MODO (mostrar si est√° logueado) -->
            <section id="modeSelector" class="mode-selector hidden">
                <div class="section-header">
                    <h1 class="section-title">Elige tu Modo de Juego</h1>
                    <p class="section-subtitle">Selecciona c√≥mo quieres competir</p>
                </div>

                <div class="modes-grid">
                    <!-- Modo R√°pido -->
                    <div class="mode-card" onclick="selectMode('quick')">
                        <div class="mode-icon">‚öîÔ∏è</div>
                        <h3 class="mode-title">Modo R√°pido</h3>
                        <p class="mode-description">
                            Matchmaking autom√°tico. Encuentra un rival en segundos y empieza a batallar.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üéØ Emparejamiento autom√°tico</span>
                            <span class="mode-feature">üí∞ Apuesta personalizada</span>
                            <span class="mode-feature">‚è±Ô∏è Partidas de 1 minuto</span>
                        </div>
                        <button class="btn-mode">Jugar Ahora</button>
                    </div>

                    <!-- Sala Privada -->
                    <div class="mode-card" onclick="selectMode('private')">
                        <div class="mode-icon">üé™</div>
                        <h3 class="mode-title">Sala Privada</h3>
                        <p class="mode-description">
                            Crea una sala e invita a tus amigos. Personaliza las reglas y apuestas.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üë• Juega con amigos</span>
                            <span class="mode-feature">üîó C√≥digo de sala √∫nico</span>
                            <span class="mode-feature">‚öôÔ∏è Reglas personalizadas</span>
                        </div>
                        <button class="btn-mode">Crear Sala</button>
                    </div>

                    <!-- Torneo -->
                    <div class="mode-card mode-coming-soon">
                        <div class="mode-icon">üèÜ</div>
                        <h3 class="mode-title">Torneo</h3>
                        <p class="mode-description">
                            Compite en torneos de eliminaci√≥n. Gana premios masivos del prize pool.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üé™ M√∫ltiples rondas</span>
                            <span class="mode-feature">üíé Grandes premios</span>
                            <span class="mode-feature">üèÖ Rankings globales</span>
                        </div>
                        <button class="btn-mode btn-disabled" disabled>Pr√≥ximamente</button>
                    </div>

                    <!-- Modo Pr√°ctica -->
                    <div class="mode-card" onclick="selectMode('practice')">
                        <div class="mode-icon">üéØ</div>
                        <h3 class="mode-title">Modo Pr√°ctica</h3>
                        <p class="mode-description">
                            Practica contra la CPU sin arriesgar tokens. Perfecto para nuevos jugadores.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üéÆ Sin riesgo</span>
                            <span class="mode-feature">üéÅ Peque√±as recompensas</span>
                            <span class="mode-feature">üìö Aprende a jugar</span>
                        </div>
                        <button class="btn-mode">Practicar</button>
                    </div>
                </div>
            </section>

            <!-- SELECCI√ìN DE CANCI√ìN Y APUESTA (para modo seleccionado) -->
            <section id="songSelection" class="hidden">
                <div class="section-header">
                    <button onclick="backToModes()" class="btn-back">‚Üê Volver</button>
                    <h2 class="section-title" id="modeTitle">Modo R√°pido</h2>
                    <p class="section-subtitle">Elige tu canci√≥n y realiza tu apuesta</p>
                </div>

                <div class="selection-container">
                    <!-- B√∫squeda -->
                    <div class="search-panel">
                        <h3>üéµ Busca tu Canci√≥n</h3>
                        <div class="search-box">
                            <input 
                                type="text" 
                                id="songSearch" 
                                placeholder="Nombre de canci√≥n o artista..."
                                class="search-input"
                            >
                            <button onclick="searchSong()" class="search-btn">üîç</button>
                        </div>

                        <!-- Resultados -->
                        <div id="searchResults" class="results-grid"></div>
                    </div>

                    <!-- Selecci√≥n Actual y Apuesta -->
                    <div class="bet-panel">
                        <div class="selected-song" id="selectedSongCard">
                            <div class="no-selection">
                                <div class="no-selection-icon">üéµ</div>
                                <p>Selecciona una canci√≥n</p>
                            </div>
                        </div>

                        <div class="bet-section">
                            <h3>üí∞ Tu Apuesta</h3>
                            <div class="bet-info">
                                <span>Balance: <strong id="userBalance">0</strong> $MTOKEN</span>
                                <span>M√≠nimo: <strong id="minBet">100</strong> $MTOKEN</span>
                            </div>
                            <input 
                                type="number" 
                                id="betAmount" 
                                placeholder="100" 
                                min="100" 
                                class="bet-input"
                            >
                            <div class="bet-quick">
                                <button onclick="quickBet(100)" class="btn-quick">100</button>
                                <button onclick="quickBet(500)" class="btn-quick">500</button>
                                <button onclick="quickBet(1000)" class="btn-quick">1K</button>
                                <button onclick="quickBet(5000)" class="btn-quick">5K</button>
                            </div>

                            <!-- Botones seg√∫n modo -->
                            <div id="actionButtons">
                                <!-- Se llenar√°n din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PANTALLA DE ESPERA -->
            <section id="waitingScreen" class="hidden">
                <div class="waiting-content">
                    <div class="waiting-spinner">‚è≥</div>
                    <h2 class="waiting-title">Buscando Oponente...</h2>
                    <p class="waiting-subtitle">Esto puede tomar unos segundos</p>
                    <button onclick="cancelSearch()" class="btn-secondary">Cancelar B√∫squeda</button>
                </div>
            </section>

            <!-- PANTALLA DE SALA PRIVADA -->
            <section id="roomScreen" class="hidden">
                <div class="room-content">
                    <div class="room-header">
                        <h2>üö™ Sala Privada</h2>
                        <div class="room-code-display">
                            <span>C√≥digo:</span>
                            <strong id="roomCode">XXXXX</strong>
                            <button onclick="copyRoomCode()" class="btn-copy">üìã</button>
                        </div>
                    </div>
                    <div class="room-players">
                        <div class="room-player" id="player1Card">
                            <div class="player-avatar">üë§</div>
                            <span class="player-name">Esperando...</span>
                        </div>
                        <div class="room-vs">VS</div>
                        <div class="room-player" id="player2Card">
                            <div class="player-avatar">‚ùì</div>
                            <span class="player-name">Esperando rival...</span>
                        </div>
                    </div>
                    <p class="room-info">Comparte el c√≥digo con tu amigo</p>
                    <button onclick="leaveRoom()" class="btn-secondary">Salir de la Sala</button>
                </div>
            </section>

            <!-- ARENA DE BATALLA (mantener el existente pero oculto inicialmente) -->
            <section id="battleSection" class="battle-section hidden">
                <!-- Tu c√≥digo de batalla actual aqu√≠ -->
            </section>

        </div>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Auth Modal (mantener el existente) -->
    <div id="authModal" class="modal hidden">
        <!-- Tu c√≥digo de auth modal aqu√≠ -->
    </div>

    <!-- Victory Modal (mantener el existente) -->
    <div id="victoryModal" class="modal hidden">
        <!-- Tu c√≥digo de victory modal aqu√≠ -->
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="/privacy.html" class="footer-link">Privacy Policy</a>
                <a href="/terms.html" class="footer-link">Terms of Service</a>
                <a href="/cdn-cgi/l/email-protection#553930323439153820263c36213a3e303b273c3b327b2d2c2f" class="footer-link">Contact</a>
            </div>
            <p class="footer-copyright">
                ¬© 2026 MusicToken Ring. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- Scripts -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="./auth-system.js"></script>
    <script src="./game-manager.js"></script>
    <script src="./src/app.js"></script>

    <script>
        // Variables globales
        let selectedSong = null;
        let currentMode = null;

        // Verificar login al cargar
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                showModeSelector();
            } else {
                showLoginWall();
            }
        });

        // Mostrar/ocultar secciones
        function showLoginWall() {
            document.getElementById('loginWall').classList.remove('hidden');
            document.getElementById('modeSelector').classList.add('hidden');
        }

        function showModeSelector() {
            document.getElementById('loginWall').classList.add('hidden');
            document.getElementById('modeSelector').classList.remove('hidden');
        }

        // Seleccionar modo
        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeSelector').classList.add('hidden');
            document.getElementById('songSelection').classList.remove('hidden');
            
            const titles = {
                'quick': 'Modo R√°pido',
                'private': 'Sala Privada',
                'practice': 'Modo Pr√°ctica'
            };
            document.getElementById('modeTitle').textContent = titles[mode];
            
            updateActionButtons(mode);
        }

        function backToModes() {
            document.getElementById('songSelection').classList.add('hidden');
            document.getElementById('modeSelector').classList.remove('hidden');
            selectedSong = null;
        }

        // Actualizar botones seg√∫n modo
        function updateActionButtons(mode) {
            const buttonsDiv = document.getElementById('actionButtons');
            
            if (mode === 'quick') {
                buttonsDiv.innerHTML = `
                    <button onclick="startQuickMatch()" class="btn-primary btn-large" id="startQuickBtn" disabled>
                        ‚ö° Buscar Rival
                    </button>
                `;
            } else if (mode === 'private') {
                buttonsDiv.innerHTML = `
                    <button onclick="createRoom()" class="btn-primary" id="createRoomBtn" disabled>
                        üö™ Crear Sala
                    </button>
                    <div class="or-divider">o</div>
                    <div class="join-room-group">
                        <input type="text" id="joinRoomCode" placeholder="C√≥digo de sala" class="room-code-input" maxlength="6">
                        <button onclick="joinRoom()" class="btn-secondary" id="joinRoomBtn" disabled>
                            Unirse
                        </button>
                    </div>
                `;
            } else if (mode === 'practice') {
                buttonsDiv.innerHTML = `
                    <button onclick="startPractice()" class="btn-primary btn-large" id="startPracticeBtn" disabled>
                        ü§ñ Iniciar Pr√°ctica
                    </button>
                `;
            }
        }

        // B√∫squeda de canciones
        function searchSong() {
            const query = document.getElementById('songSearch').value;
            searchDeezer(query);
        }

        function searchDeezer(query) {
            if (!query.trim()) return;
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<p style="text-align: center; padding: 20px;">üîç Buscando...</p>';
            
            const callbackName = `deezerCallback_${Date.now()}`;
            
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.getElementById(callbackName)?.remove();
                
                if (!data.data || data.data.length === 0) {
                    resultsDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #9CA3AF;">No se encontraron resultados</p>';
                    return;
                }
                
                let html = '';
                data.data.forEach(track => {
                    html += `
                        <div class="track-item" onclick='selectSongForBattle(${JSON.stringify({
                            id: track.id,
                            name: track.title,
                            artist: track.artist.name,
                            image: track.album.cover_big,
                            preview: track.preview
                        }).replace(/'/g, "&#39;")})'>
                            <img src="${track.album.cover_medium}" alt="${track.title}">
                            <div class="track-info">
                                <div class="track-name">${track.title}</div>
                                <div class="track-artist">${track.artist.name}</div>
                            </div>
                            ${track.preview ? `
                                <button class="btn-preview" onclick="event.stopPropagation(); togglePreview('${track.preview}', this)">
                                    ‚ñ∂ Preview
                                </button>
                            ` : ''}
                        </div>
                    `;
                });
                resultsDiv.innerHTML = html;
            };
            
            const script = document.createElement('script');
            script.id = callbackName;
            script.src = `https://api.deezer.com/search?q=${encodeURIComponent(query)}&limit=6&output=jsonp&callback=${callbackName}`;
            document.head.appendChild(script);
        }

        // Seleccionar canci√≥n
        function selectSongForBattle(song) {
            selectedSong = song;
            
            const cardDiv = document.getElementById('selectedSongCard');
            cardDiv.innerHTML = `
                <img src="${song.image}" alt="${song.name}" class="selected-song-image">
                <div class="selected-song-info">
                    <h4>${song.name}</h4>
                    <p>${song.artist}</p>
                </div>
            `;
            
            // Habilitar botones
            document.querySelectorAll('#actionButtons button').forEach(btn => {
                if (!btn.classList.contains('btn-disabled')) {
                    btn.disabled = false;
                }
            });
        }

        // Apuesta r√°pida
        function quickBet(amount) {
            document.getElementById('betAmount').value = amount;
        }

        // Iniciar seg√∫n modo
        async function startQuickMatch() {
            if (!selectedSong) return;
            const bet = parseInt(document.getElementById('betAmount').value) || 100;
            await GameManager.joinQuickMatch(selectedSong, bet);
        }

        async function createRoom() {
            if (!selectedSong) return;
            const bet = parseInt(document.getElementById('betAmount').value) || 100;
            await GameManager.createPrivateRoom(selectedSong, bet);
        }

        async function joinRoom() {
            if (!selectedSong) return;
            const roomCode = document.getElementById('joinRoomCode').value.toUpperCase();
            const bet = parseInt(document.getElementById('betAmount').value) || 100;
            await GameManager.joinPrivateRoom(roomCode, selectedSong, bet);
        }

        async function startPractice() {
            if (!selectedSong) return;
            // Seleccionar canci√≥n aleatoria para CPU
            // Por ahora usar la misma l√≥gica
            await GameManager.startPracticeMatch(selectedSong, selectedSong);
        }

        function cancelSearch() {
            // Implementar cancelaci√≥n
            backToModes();
        }

        function leaveRoom() {
            // Implementar salir de sala
            backToModes();
        }

        function copyRoomCode() {
            const code = document.getElementById('roomCode').textContent;
            navigator.clipboard.writeText(code);
            showToast('C√≥digo copiado', 'success');
        }

        // Enter key en b√∫squeda
        document.getElementById('songSearch')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchSong();
        });
    </script>

