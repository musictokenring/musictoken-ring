<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
 codex/fix-issues-from-codex-review-on-pr-#117-js14p8
    <meta name="mtr-build" content="20260228mtr2">

 codex/fix-issues-from-codex-review-on-pr-#117-yqd0oa
    <meta name="mtr-build" content="20260228mtr2">

 codex/fix-issues-from-codex-review-on-pr-#117-snau6z
    <meta name="mtr-build" content="20260228mtr2">

    <meta name="mtr-build" content="20260227mtr-hotfix-ui2">
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
    <title>MusicToken Ring - Music Battle Arena</title>
   
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
   
    <!-- Styles -->
 codex/fix-issues-from-codex-review-on-pr-#117-js14p8
    <link rel="stylesheet" href="./styles/main.css?v=20260228mtr2">

 codex/fix-issues-from-codex-review-on-pr-#117-yqd0oa
    <link rel="stylesheet" href="./styles/main.css?v=20260228mtr2">

 codex/fix-issues-from-codex-review-on-pr-#117-snau6z
    <link rel="stylesheet" href="./styles/main.css?v=20260228mtr2">

    <link rel="stylesheet" href="./styles/main.css?v=20260227mtr-hotfix-ui2">
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
   
    <link rel="icon" type="image/png" href="https://pink-blank-vicuna-260.mypinata.cloud/ipfs/bafybeie24pisqmw6teijdng4flzjwumgwpesilowjxq3kww3p7kxlmuywm">

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const CONFIG = {
            SUPABASE_URL: 'https://bscmgcnynbxalcuwdqlm.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzY21nY255bmJ4YWxjdXdkcWxtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTYwOTUsImV4cCI6MjA4NjAzMjA5NX0.1iasFQ5H0GmrFqi6poWNE1aZOtbmQuB113RCyg2BBK4',
            BATTLE_DURATION: 60,
            BACKEND_API: 'https://musictoken-backend.onrender.com',
            MTR_TOKEN_ADDRESS: window.MTR_TOKEN_ADDRESS || '0x99cd1eb32846c9027ed9cb8710066fa08791c33b'
        };
        function extractMetaMaskErrorMessage(reason) {
            if (!reason) return '';
            const direct = String(reason?.message || reason || '');
            const cause = String(reason?.cause?.message || '');
            return `${direct} ${cause}`.toLowerCase();
        }

        function isMetaMaskUnavailableError(reason) {
            const message = extractMetaMaskErrorMessage(reason);
            return message.includes('metamask extension not found') ||
                message.includes('failed to connect to metamask');
        }

        window.addEventListener('unhandledrejection', (event) => {
            if (!isMetaMaskUnavailableError(event.reason)) return;
            event.preventDefault();
            console.warn('MetaMask no est√° disponible en este navegador.');
            if (typeof showToast === 'function') {
                showToast('MetaMask no est√° disponible. Instala la extensi√≥n para conectar tu wallet.', 'error');
            }
        });

        const PLATFORM_WALLET_ADDRESSES = {
            base: window.PLATFORM_WALLET_BASE_ADDRESS || '0x75376BC58830f27415402875D26B73A6BE8E2253'
        };
 codex/fix-issues-from-codex-review-on-pr-#117-js14p8
        window.MTR_BUILD_ID = '20260228mtr2';

 codex/fix-issues-from-codex-review-on-pr-#117-yqd0oa
        window.MTR_BUILD_ID = '20260228mtr2';

 codex/fix-issues-from-codex-review-on-pr-#117-snau6z
        window.MTR_BUILD_ID = '20260228mtr2';

        window.MTR_BUILD_ID = '20260227mtr-hotfix-ui2';
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v

        // Critical UI fallbacks: keep mode buttons functional even if a later script fails to parse/load.
        if (typeof window.selectMode !== 'function') {
            window.selectMode = function selectModeCriticalFallback(mode) {
                var modeSelector = document.getElementById('modeSelector');
                var songSelection = document.getElementById('songSelection');
                var modeTitle = document.getElementById('modeTitle');
                var titles = {
                    quick: 'Modo R√°pido',
                    private: 'Sala Privada',
                    practice: 'Modo Pr√°ctica',
                    tournament: 'Modo Torneo'
                };

                window.currentMode = mode || null;
                if (modeSelector) modeSelector.classList.add('hidden');
                if (songSelection) songSelection.classList.remove('hidden');
                if (modeTitle) modeTitle.textContent = titles[mode] || 'Modo de Juego';
            };
        }

        if (typeof window.backToModes !== 'function') {
            window.backToModes = function backToModesCriticalFallback() {
                var modeSelector = document.getElementById('modeSelector');
                var songSelection = document.getElementById('songSelection');
                if (songSelection) songSelection.classList.add('hidden');
                if (modeSelector) modeSelector.classList.remove('hidden');
                window.currentMode = null;
            };
        }

        console.log('üéµ MusicToken Ring loaded! build=' + window.MTR_BUILD_ID);
    </script>

    <style>
        /* Fallback styles to avoid broken/plain rendering if cached CSS is stale */
        .btn-link-primary{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:10px;color:#fff;text-decoration:none;font-weight:700;background:#2563eb;box-shadow:0 8px 20px rgba(37,99,235,.35)}
        .btn-link-primary:hover{background:#1d4ed8}
        .w-12{width:48px}.h-12{height:48px}.rounded-full{border-radius:9999px}.w-5{width:20px}.h-5{height:20px}
        .mtr-logo-large{width:110px;height:110px;border-radius:9999px;object-fit:cover}
    </style>

</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
 codex/fix-issues-from-codex-review-on-pr-#117-js14p8
                    <img src="https://pink-blank-vicuna-260.mypinata.cloud/ipfs/bafybeiah2fffgw6y6aomfx5b5pgav7wedo3qdtqxqteg2glvmgzs6fpivu" alt="MTR Logo" class="logo-icon w-12 h-12 rounded-full" onerror="this.style.display='none'">

 codex/fix-issues-from-codex-review-on-pr-#117-yqd0oa
                    <img src="https://pink-blank-vicuna-260.mypinata.cloud/ipfs/bafybeiah2fffgw6y6aomfx5b5pgav7wedo3qdtqxqteg2glvmgzs6fpivu" alt="MTR Logo" class="logo-icon w-12 h-12 rounded-full" onerror="this.style.display='none'">

                    <img src="https://pink-blank-vicuna-260.mypinata.cloud/ipfs/bafybeiah2fffgw6y6aomfx5b5pgav7wedo3qdtqxqteg2glvmgzs6fpivu" alt="MTR Logo" class="logo-icon w-12 h-12 rounded-full">
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
                    <span class="logo-text">MusicToken Ring</span>
                </div>
                <h2 class="slogan">Music Token Ring ‚Äì The Wall Street of Beats</h2>
                
                <div class="header-badges">
                    <span class="badge">üéµ Deezer</span>
                    <span class="badge badge-live">üî¥ Live</span>
 codex/fix-issues-from-codex-review-on-pr-#117-js14p8
                    <span class="badge" id="onchainBalanceDisplay">On-chain: --</span>
                    <span class="badge" id="appBalanceDisplay">Jugable: --</span>

 codex/fix-issues-from-codex-review-on-pr-#117-yqd0oa
                    <span class="badge" id="onchainBalanceDisplay">On-chain: --</span>
                    <span class="badge" id="appBalanceDisplay">Jugable: --</span>

                    <span class="badge" id="onchainBalanceDisplay">Tu MTR: --</span>
                    <span class="badge" id="appBalanceDisplay">Saldo jugable: --</span>
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
                </div>

                <div class="wallet-section">
                    <button type="button" id="walletConnectBtn" class="btn-secondary btn-wallet">
                        Conectar Wallet
                    </button>
                    <span id="walletAddress" class="wallet-address hidden"></span>
                </div>
                
                <!-- AUTH BUTTON -->
                <div id="authButton">
                    <button type="button" onclick="openAuthModal()" class="btn-login">
                        Iniciar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <section id="streamDashboard" class="stream-dashboard">
                <div class="stream-dashboard-header">
                    <h2>üìà Wall Street of Beats</h2>
                    <p>Top streams por regi√≥n (√∫ltimos 5 min)</p>
                </div>
                <div class="stream-region-tabs">
                    <button type="button" class="stream-region-tab active" data-region="latam" onclick="setDashboardRegion('latam')">Latam</button>
                    <button type="button" class="stream-region-tab" data-region="us" onclick="setDashboardRegion('us')">US</button>
                    <button type="button" class="stream-region-tab" data-region="eu" onclick="setDashboardRegion('eu')">EU</button>
                </div>
                <div class="stream-carousel-wrap">
                    <button type="button" class="stream-carousel-nav" onclick="moveDashboardCarousel(-1)">‚Äπ</button>
                    <div id="streamDashboardTrackList" class="stream-carousel-track">
                        <article class="stream-card">
                            <img src="https://e-cdns-images.dzcdn.net/images/cover/9f4c9025e2f4f4be85a8d0f95f3bc5fe/250x250-000000-80-0-0.jpg" alt="Luna">
                            <div class="stream-card-info">
                                <strong>Luna</strong>
                                <span>Feid</span>
                                <span class="stream-delta neutral">‚Ä¢ 34.1% del top</span>
                            </div>
                        </article>
                        <article class="stream-card">
                            <img src="https://e-cdns-images.dzcdn.net/images/cover/4aa4b9f4674f7f9f7428962456f31cc7/250x250-000000-80-0-0.jpg" alt="Si Antes Te Hubiera Conocido">
                            <div class="stream-card-info">
                                <strong>Si Antes Te Hubiera Conocido</strong>
                                <span>KAROL G</span>
                                <span class="stream-delta neutral">‚Ä¢ 33.0% del top</span>
                            </div>
                        </article>
                        <article class="stream-card">
                            <img src="https://e-cdns-images.dzcdn.net/images/cover/236f9df9f6f95cc8c6f0707dbe6839df/250x250-000000-80-0-0.jpg" alt="Perro Negro">
                            <div class="stream-card-info">
                                <strong>Perro Negro</strong>
                                <span>Bad Bunny</span>
                                <span class="stream-delta neutral">‚Ä¢ 33.3% del top</span>
                            </div>
                        </article>
                    </div>
                    <button type="button" class="stream-carousel-nav" onclick="moveDashboardCarousel(1)">‚Ä∫</button>
                </div>
            </section>
            
            <!-- LOGIN WALL (mostrar si no est√° logueado) -->
            <section id="loginWall" class="login-wall">
                <div class="login-wall-content">
                    <div class="login-wall-icon">ü•ä</div>
                    <h1 class="login-wall-title">Bienvenido a MusicToken Ring</h1>
                    <p class="login-wall-subtitle">
                        Batalla con tus canciones favoritas, apuesta MTR y demuestra qui√©n tiene mejor gusto musical
                    </p>
                    <button type="button" onclick="openAuthModal()" class="btn-primary btn-large">
                        Iniciar Sesi√≥n para Jugar
                    </button>
                    <div class="login-wall-features">
                        <div class="feature-item">
                            <span class="feature-icon">‚öîÔ∏è</span>
                            <span class="feature-text">Modo R√°pido</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üé™</span>
                            <span class="feature-text">Salas Privadas</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üèÜ</span>
                            <span class="feature-text">Torneos</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üéØ</span>
                            <span class="feature-text">Modo Pr√°ctica</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="streaming-showcase">
                <p class="streaming-label">Streaming partners</p>
                <div class="streaming-logos">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/deezer.svg" alt="Deezer" class="streaming-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/spotify.svg" alt="Spotify" class="streaming-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/applemusic.svg" alt="Apple Music" class="streaming-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/youtubemusic.svg" alt="YouTube Music" class="streaming-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/amazonmusic.svg" alt="Amazon Music" class="streaming-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/tidal.svg" alt="Tidal" class="streaming-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/soundcloud.svg" alt="SoundCloud" class="streaming-logo" onerror="this.style.display='none'">
                </div>
            </section>

            <section class="payments-showcase">
                <p class="streaming-label">Pagos en Base con MTR</p>
                <div class="payment-controls">
                    <label for="preferredNetwork" class="payment-label">Red Base para pagos</label>
                    <select id="preferredNetwork" class="payment-select" onchange="setPreferredNetwork(this.value)"></select>
                </div>
                <div class="currency-logos">
                                        <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/ethereum.svg" alt="Ethereum" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/optimism.svg" alt="Optimism" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/base.svg" alt="Base" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/bnbchain.svg" alt="BNB Chain" class="currency-logo" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/binance.svg';">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/arbitrum.svg" alt="Arbitrum" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/linea.svg" alt="Linea" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/tron.svg" alt="Tron" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/solana.svg" alt="Solana" class="currency-logo" onerror="this.style.display='none'">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/bitcoin.svg" alt="Bitcoin" class="currency-logo" onerror="this.style.display='none'">
                </div>
                <div class="wallet-directory" id="walletDirectory"></div>

                <div class="settlement-panel">
                    <div class="settlement-card">
                        <h4>Comprar MTR directo</h4>
                        <p class="settlement-help">
                            Compra MTR en Aerodrome y vuelve aqu√≠. Despu√©s registra el hash en "Acreditar compra" para sumar saldo jugable.
                        </p>
                        <div class="settlement-grid">
 codex/fix-issues-from-codex-review-on-pr-#117-js14p8

 codex/fix-issues-from-codex-review-on-pr-#117-yqd0oa
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
                            <a class="btn-primary btn-link-primary bg-blue-600 hover:bg-blue-700 shadow" target="_blank" rel="noopener noreferrer" href="https://aerodrome.finance/swap?from=ETH&to=0x99cd1eb32846c9027ed9cb8710066fa08791c33b">
                                <svg class="link-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                Jugar Ahora
                            </a>
                            <a class="btn-primary btn-link-primary bg-blue-600 hover:bg-blue-700 shadow" target="_blank" rel="noopener noreferrer" href="https://basescan.org/address/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">
                                <svg class="link-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                Ver Contrato en Basescan
                            </a>
                            <a class="btn-primary btn-link-primary bg-blue-600 hover:bg-blue-700 shadow" target="_blank" rel="noopener noreferrer" href="https://basescan.org/token/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">
                                <svg class="link-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                Ver Supply 99.99M MTR
                            </a>
 codex/fix-issues-from-codex-review-on-pr-#117-js14p8
                            <p class="settlement-help">Contrato MTR: <a target="_blank" rel="noopener noreferrer" href="https://basescan.org/token/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">0x99cd1eb32846c9027ed9cb8710066fa08791c33b</a></p>
                            <input id="depositTxHash" class="payment-input" type="text" placeholder="Pega el hash de compra (0x...)" autocomplete="off">
                            <button type="button" class="btn-secondary" id="creditPurchaseBtn" onclick="creditPurchasedMtr()">‚úÖ Acreditar compra</button>

                            <p class="settlement-help">Contrato MTR: <a target="_blank" rel="noopener noreferrer" href="https://basescan.org/token/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">0x99cd1eb32846c9027ed9cb8710066fa08791c33b</a></p>
                            <input id="depositTxHash" class="payment-input" type="text" placeholder="Pega el hash de compra (0x...)" autocomplete="off">
                            <button type="button" class="btn-secondary" id="creditPurchaseBtn" onclick="creditPurchasedMtr()">‚úÖ Acreditar compra</button>

 codex/fix-issues-from-codex-review-on-pr-#117-snau6z

 codex/fix-issues-from-codex-review-on-pr-#117-6lh27n
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
                            <a class="btn-link-primary bg-blue-600 hover:bg-blue-700 shadow" target="_blank" rel="noopener noreferrer" href="https://aerodrome.finance/swap?from=ETH&to=0x99cd1eb32846c9027ed9cb8710066fa08791c33b">
                                <svg class="link-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                Jugar Ahora
                            </a>
                            <a class="btn-link-primary bg-blue-600 hover:bg-blue-700 shadow" target="_blank" rel="noopener noreferrer" href="https://basescan.org/address/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">
                                <svg class="link-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                Ver Contrato en Basescan
                            </a>
                            <a class="btn-link-primary bg-blue-600 hover:bg-blue-700 shadow" target="_blank" rel="noopener noreferrer" href="https://basescan.org/token/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">
                                <svg class="link-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                Ver Supply 99.99M MTR
                            </a>
 codex/fix-issues-from-codex-review-on-pr-#117-snau6z
                            <p class="settlement-help">Contrato MTR: <a target="_blank" rel="noopener noreferrer" href="https://basescan.org/token/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">0x99cd1eb32846c9027ed9cb8710066fa08791c33b</a></p>
                            <input id="depositTxHash" class="payment-input" type="text" placeholder="Pega el hash de compra (0x...)" autocomplete="off">
                            <button type="button" class="btn-secondary" id="creditPurchaseBtn" onclick="creditPurchasedMtr()">‚úÖ Acreditar compra</button>

                            <p class="settlement-help">Contrato MTR: <a target="_blank" rel="noopener noreferrer" href="https://basescan.org/token/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">0x99cd1eb32846c9027ed9cb8710066fa08791c33b</a></p>
                            <input id="depositTxHash" class="payment-input" type="text" placeholder="Pega el hash de compra (0x...)" autocomplete="off">
                            <button type="button" class="btn-secondary" id="creditPurchaseBtn" onclick="creditPurchasedMtr()">‚úÖ Acreditar compra</button>

 codex/fix-issues-from-codex-review-on-pr-#117-ttd7et
                            <a class="btn-link-primary bg-blue-600" target="_blank" rel="noopener noreferrer" href="https://aerodrome.finance/swap?from=ETH&to=0x99cd1eb32846c9027ed9cb8710066fa08791c33b">
                                <svg class="link-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                Jugar Ahora
                            </a>
                            <a class="btn-link-primary bg-blue-600" target="_blank" rel="noopener noreferrer" href="https://basescan.org/address/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">
                                <svg class="link-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                Ver Contrato en Basescan
                            </a>
                            <a class="btn-link-primary bg-blue-600" target="_blank" rel="noopener noreferrer" href="https://basescan.org/token/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">
                                <svg class="link-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                Ver Supply 99.99M MTR
                            </a>
                            <p class="settlement-help">Contrato MTR: <a target="_blank" rel="noopener noreferrer" href="https://basescan.org/token/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">0x99cd1eb32846c9027ed9cb8710066fa08791c33b</a></p>
                            <input id="depositTxHash" class="payment-input" type="text" placeholder="Pega el hash de compra (0x...)" autocomplete="off">
                            <button type="button" class="btn-secondary" id="creditPurchaseBtn" onclick="creditPurchasedMtr()">‚úÖ Acreditar compra</button>

                            <a class="btn-primary" target="_blank" rel="noopener noreferrer" href="https://aerodrome.finance/swap?from=ETH&to=0x99cd1eb32846c9027ed9cb8710066fa08791c33b">Comprar MTR en Aerodrome</a>
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
                            <p class="settlement-help">Contrato oficial MTR en Base (checksum validado).</p>
                            <a class="btn-secondary" target="_blank" rel="noopener noreferrer" href="https://basescan.org/token/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">üîé Ver token MTR y supply en Basescan</a>
                            <p class="settlement-help">Contrato MTR: <a target="_blank" rel="noopener noreferrer" href="https://basescan.org/token/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">0x99cd1eb32846c9027ed9cb8710066fa08791c33b</a></p>
                            <input id="depositTxHash" class="payment-input" type="text" placeholder="Pega el hash de compra (0x...)" autocomplete="off">
                            <button type="button" class="btn-secondary" id="creditPurchaseBtn" onclick="creditPurchasedMtr()">‚úÖ Acreditar compra</button>

                            <a class="btn-basescan" target="_blank" rel="noopener noreferrer" href="https://basescan.org/address/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">üîé Ver contrato en Basescan</a>
                            <p class="settlement-help">Contrato MTR: <a target="_blank" rel="noopener noreferrer" href="https://basescan.org/address/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">0x99cd1eb32846c9027ed9cb8710066fa08791c33b</a></p>
 main
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
                        </div>
                        
                    </div>

                    <div class="settlement-card">
                        <h4>Liquidaci√≥n de ganancias (MTR ‚Üí USD digital)</h4>
                        <p class="settlement-help">
                            Solicita retiro cuando tengas saldo. El backend cotiza con referencia USD y registra la comisi√≥n antes de liquidar.
                        </p>
                        <div class="settlement-grid">
                            <input id="cashoutAmount" class="payment-input" type="number" min="1" placeholder="MTR a retirar">
                            <button type="button" class="btn-secondary" onclick="quoteCashout()">üìä Cotizar en USD</button>
                        </div>
                        <p class="settlement-quote" id="cashoutQuote">Sin cotizaci√≥n a√∫n.</p>
                        <button type="button" class="btn-primary" onclick="requestCashout()">üí∏ Solicitar retiro</button>
                    </div>
                </div>
            </section>

            <section class="payments-showcase">
                <p class="streaming-label">Sobre MTR</p>
                <div class="settlement-card about-mtr-card">
 codex/fix-issues-from-codex-review-on-pr-#117-js14p8

 codex/fix-issues-from-codex-review-on-pr-#117-yqd0oa
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
                    <img src="https://pink-blank-vicuna-260.mypinata.cloud/ipfs/bafybeiah2fffgw6y6aomfx5b5pgav7wedo3qdtqxqteg2glvmgzs6fpivu" alt="MTR Logo" class="mtr-logo-large" onerror="this.style.display='none'">
                    <p>Token ERC-20 en Base. Liquidez lockeada en Aerodrome.</p>
                    <p>Contrato verificado: <a target="_blank" rel="noopener noreferrer" href="https://basescan.org/address/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">0x99cd1eb32846c9027ed9cb8710066fa08791c33b</a></p>
                    <p>Supply total: 99,990,000 MTR (99.99M).</p>
 codex/fix-issues-from-codex-review-on-pr-#117-js14p8


                    <img src="https://pink-blank-vicuna-260.mypinata.cloud/ipfs/bafybeiah2fffgw6y6aomfx5b5pgav7wedo3qdtqxqteg2glvmgzs6fpivu" alt="MTR Logo" class="mtr-logo-large">
                    <p>Token ERC-20 en Base. Liquidez lockeada en Aerodrome.</p>
 codex/fix-issues-from-codex-review-on-pr-#117-snau6z
                    <p>Contrato verificado: <a target="_blank" rel="noopener noreferrer" href="https://basescan.org/address/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">0x99cd1eb32846c9027ed9cb8710066fa08791c33b</a></p>
                    <p>Supply total: 99,990,000 MTR (99.99M).</p>

 codex/fix-issues-from-codex-review-on-pr-#117-6lh27n
                    <p>Contrato verificado: <a target="_blank" rel="noopener noreferrer" href="https://basescan.org/address/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">0x99cd1eb32846c9027ed9cb8710066fa08791c33b</a></p>
                    <p>Supply total: 99,990,000 MTR (99.99M).</p>

 codex/fix-issues-from-codex-review-on-pr-#117-ttd7et
                    <p>Contrato verificado: <a target="_blank" rel="noopener noreferrer" href="https://basescan.org/address/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">0x99cd1eb32846c9027ed9cb8710066fa08791c33b</a></p>
                    <p>Supply total: 99,990,000 MTR (99.99M).</p>

                    <p>Contrato: 0x99cd1eb32846c9027ed9cb8710066fa08791c33b.</p>
                    <p>Contrato verificado: 0x99cd1eb32846c9027ed9cb8710066fa08791c33b ‚ÄîSupply total: 99,990,000 MTR.</p>
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
                    <div class="settlement-grid">
                        <a class="btn-primary" target="_blank" rel="noopener noreferrer" href="https://basescan.org/token/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">üìà Ver token MTR en Basescan</a>
                        <p class="settlement-help">Este bot√≥n abre el explorer del token para ver supply, holders y transacciones.</p>
                    </div>

                    <a class="btn-basescan" target="_blank" rel="noopener noreferrer" href="https://basescan.org/token/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">üìà Ver token MTR en Basescan</a>
                    <p>Explorer: <a target="_blank" rel="noopener noreferrer" href="https://basescan.org/address/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">https://basescan.org/address/0x99cd1eb32846c9027ed9cb8710066fa08791c33b</a></p>
 main
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
                </div>
            </section>

            <!-- SELECTOR DE MODO (mostrar si est√° logueado) -->
            <section id="modeSelector" class="mode-selector hidden">
                <div class="section-header">
                    <h1 class="section-title">Elige tu Modo de Juego</h1>
                    <p class="section-subtitle">Selecciona c√≥mo quieres competir</p>
                </div>

                <div class="modes-grid">
                    <!-- Modo R√°pido -->
                    <div class="mode-card" onclick="selectMode('quick')">
                        <div class="mode-icon">‚öîÔ∏è</div>
                        <h3 class="mode-title">Modo R√°pido</h3>
                        <p class="mode-description">
                            Matchmaking autom√°tico. Encuentra un rival en segundos y empieza a batallar.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üéØ Emparejamiento autom√°tico</span>
                            <span class="mode-feature">üí∞ Apuesta personalizada</span>
                            <span class="mode-feature">‚è±Ô∏è Partidas de 1 minuto</span>
                        </div>
                        <button type="button" class="btn-mode" onclick="selectMode('quick')">Jugar Ahora</button>
                    </div>

                    <!-- Sala Privada -->
                    <div class="mode-card" onclick="selectMode('private')">
                        <div class="mode-icon">üé™</div>
                        <h3 class="mode-title">Sala Privada</h3>
                        <p class="mode-description">
                            Crea una sala e invita a tus amigos. Personaliza las reglas y apuestas.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üë• Juega con amigos</span>
                            <span class="mode-feature">üîó C√≥digo de sala √∫nico</span>
                            <span class="mode-feature">‚öôÔ∏è Reglas personalizadas</span>
                        </div>
                        <button type="button" class="btn-mode" onclick="selectMode('private')">Crear Sala</button>
                    </div>

                    <!-- Torneo -->
                    <div class="mode-card" onclick="selectMode('tournament')">
                        <div class="mode-icon">üèÜ</div>
                        <h3 class="mode-title">Torneo</h3>
                        <p class="mode-description">
                            Compite en torneos de eliminaci√≥n. Gana premios masivos del prize pool.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üé™ M√∫ltiples rondas</span>
                            <span class="mode-feature">üíé Grandes premios</span>
                            <span class="mode-feature">üèÖ Rankings globales</span>
                        </div>
                        <button type="button" class="btn-mode" onclick="selectMode('tournament')">Unirse al Torneo</button>
                    </div>

                    <!-- Modo Pr√°ctica -->
                    <div class="mode-card" onclick="selectMode('practice')">
                        <div class="mode-icon">üéØ</div>
                        <h3 class="mode-title">Modo Pr√°ctica</h3>
                        <p class="mode-description">
                            Practica contra la CPU sin arriesgar tokens. Perfecto para nuevos jugadores.
                        </p>
                        <div class="mode-features">
                            <span class="mode-feature">üéÆ Sin riesgo</span>
                            <span class="mode-feature">üéÅ Peque√±as recompensas</span>
                            <span class="mode-feature">üìö Aprende a jugar</span>
                        </div>
                        <button type="button" class="btn-mode" onclick="selectMode('practice')">Practicar</button>
                    </div>
                </div>
            </section>

            <!-- SELECCI√ìN DE CANCI√ìN Y APUESTA -->
            <section id="songSelection" class="hidden">
                <div class="section-header">
                    <button type="button" onclick="backToModes()" class="btn-back">‚Üê Volver</button>
                    <h2 class="section-title" id="modeTitle">Modo R√°pido</h2>
                    <p class="section-subtitle">Elige tu canci√≥n y realiza tu apuesta</p>
                </div>

                <div class="selection-container">
                    <!-- B√∫squeda -->
                    <div class="search-panel">
                        <h3>üéµ Busca tu Canci√≥n</h3>
                        <div class="search-box">
                            <input 
                                type="text" 
                                id="songSearch" 
                                placeholder="Nombre de canci√≥n o artista..."
                                class="search-input"
                            >
                            <button type="button" onclick="searchSong()" class="search-btn">üîç</button>
                        </div>

                        <!-- Resultados -->
                        <div id="searchResults" class="results-grid"></div>
                    </div>

                    <!-- Selecci√≥n Actual y Apuesta -->
                    <div class="bet-panel">
                        <div class="selected-song" id="selectedSongCard">
                            <div class="no-selection">
                                <div class="no-selection-icon">üéµ</div>
                                <p>Selecciona una canci√≥n</p>
                            </div>
                        </div>

                        <div class="bet-section">
                            <h3>üí∞ Tu Apuesta</h3>
                            <div class="bet-info">
                                <span><span id="balanceLabel">Tu MTR (on-chain)</span>: <strong id="onchainMtrBalance">--</strong> MTR</span>
                                <span>Saldo jugable: <strong id="userBalance">0</strong> MTR</span>
                                <span>M√≠nimo: <strong id="minBet">100</strong> MTR</span>
                            </div>
                            <input 
                                type="number" 
                                id="betAmount" 
                                placeholder="100" 
                                min="100" 
                                class="bet-input"
                            >
                            <div class="bet-quick">
                                <button type="button" onclick="quickBet(100)" class="btn-quick">100</button>
                                <button type="button" onclick="quickBet(500)" class="btn-quick">500</button>
                                <button type="button" onclick="quickBet(1000)" class="btn-quick">1K</button>
                                <button type="button" onclick="quickBet(5000)" class="btn-quick">5K</button>
                            </div>

                            <!-- Botones seg√∫n modo -->
                            <div id="actionButtons"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PANTALLA DE ESPERA -->
            <section id="waitingScreen" class="hidden">
                <div class="waiting-content">
                    <div class="waiting-spinner">‚è≥</div>
                    <h2 class="waiting-title">Buscando Oponente...</h2>
                    <p class="waiting-subtitle">Esto puede tomar unos segundos</p>
                    <button type="button" onclick="cancelSearch()" class="btn-secondary">Cancelar B√∫squeda</button>
                </div>
            </section>

            <!-- PANTALLA DE SALA PRIVADA -->
            <section id="roomScreen" class="hidden">
                <div class="room-content">
                    <div class="room-header">
                        <h2>üé™ Sala Privada</h2>
                        <div class="room-code-display">
                            <span>C√≥digo:</span>
                            <strong id="roomCode">XXXXX</strong>
                            <button type="button" onclick="copyRoomCode()" class="btn-copy">üìã</button>
                        </div>
                    </div>
                    <div class="room-invite">
                        <label for="roomInviteLink">Link privado para invitar</label>
                        <div class="room-invite-actions">
                            <input id="roomInviteLink" type="text" readonly class="room-invite-input">
                            <button type="button" onclick="copyRoomLink()" class="btn-secondary">Copiar link</button>
                        </div>
                    </div>
                    <div class="room-players">
                        <div class="room-player" id="player1Card">
                            <div class="player-avatar">üë§</div>
                            <span class="player-name">Esperando...</span>
                        </div>
                        <div class="room-vs">VS</div>
                        <div class="room-player" id="player2Card">
                            <div class="player-avatar">‚ùì</div>
                            <span class="player-name">Esperando rival...</span>
                        </div>
                    </div>
                    <p class="room-info">Comparte el c√≥digo con tu amigo</p>
                    <button type="button" onclick="leaveRoom()" class="btn-secondary">Salir de la Sala</button>
                </div>
            </section>

        </div>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal hidden">
        <div class="modal-overlay" onclick="closeAuthModal()"></div>
        <div class="modal-content auth-modal-content">
            <button type="button" onclick="closeAuthModal()" class="modal-close">√ó</button>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <h2 class="auth-title">Iniciar Sesi√≥n</h2>
                <p class="auth-subtitle">Accede a tu cuenta para guardar tu progreso</p>
                
                <!-- Google Login -->
                <button type="button" onclick="loginWithGoogle()" class="btn-google">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/>
                        <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                        <path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/>
                        <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                    </svg>
                    Continuar con Google
                </button>
                
                <div class="auth-divider">
                    <span>o</span>
                </div>
                
                <!-- Email Login -->
                <form onsubmit="handleLoginSubmit(event)">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input 
                            type="email" 
                            id="loginEmail" 
                            class="form-input" 
                            placeholder="tu@email.com"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">Contrase√±a</label>
                        <input 
                            type="password" 
                            id="loginPassword" 
                            class="form-input" 
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                        >
                    </div>
                    
                    <button type="submit" class="btn-primary btn-block">
                        Iniciar Sesi√≥n
                    </button>
                </form>
                
                <p class="auth-switch">
                    ¬øNo tienes cuenta? 
                    <a href="#" onclick="switchToSignup(); return false;">Reg√≠strate</a>
                </p>
            </div>
            
            <!-- Signup Form -->
            <div id="signupForm" class="auth-form hidden">
                <h2 class="auth-title">Crear Cuenta</h2>
                <p class="auth-subtitle">√önete a MusicToken Ring</p>
                
                <!-- Google Signup -->
                <button type="button" onclick="loginWithGoogle()" class="btn-google">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/>
                        <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                        <path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/>
                        <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                    </svg>
                    Continuar con Google
                </button>
                
                <div class="auth-divider">
                    <span>o</span>
                </div>
                
                <!-- Email Signup -->
                <form onsubmit="handleSignupSubmit(event)">
                    <div class="form-group">
                        <label for="signupName">Nombre</label>
                        <input 
                            type="text" 
                            id="signupName" 
                            class="form-input" 
                            placeholder="Tu nombre"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input 
                            type="email" 
                            id="signupEmail" 
                            class="form-input" 
                            placeholder="tu@email.com"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPassword">Contrase√±a</label>
                        <input 
                            type="password" 
                            id="signupPassword" 
                            class="form-input" 
                            placeholder="M√≠nimo 6 caracteres"
                            required
                            minlength="6"
                        >
                    </div>
                    
                    <button type="submit" class="btn-primary btn-block">
                        Crear Cuenta
                    </button>
                </form>
                
                <p class="auth-switch">
                    ¬øYa tienes cuenta? 
                    <a href="#" onclick="switchToLogin(); return false;">Inicia sesi√≥n</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Player Profile Modal -->
    <div id="profileModal" class="modal hidden">
        <div class="modal-overlay" onclick="closeProfileModal()"></div>
        <div class="modal-content profile-modal-content">
            <button type="button" onclick="closeProfileModal()" class="modal-close">√ó</button>
            <h2 class="auth-title">Perfil del Jugador</h2>
            <p class="auth-subtitle">Resumen de rendimiento y actividad reciente</p>

            <div class="profile-header">
                <p id="profileDisplayName" class="profile-name">Jugador</p>
                <p id="profileEmail" class="profile-email">-</p>
                <p class="profile-since">Miembro desde: <span id="profileSince">-</span></p>
            </div>

            <div class="profile-stats-grid">
                <div class="profile-stat-card"><span>Balance</span><strong id="profileBalance">-</strong></div>
                <div class="profile-stat-card"><span>Partidas</span><strong id="profileMatches">-</strong></div>
                <div class="profile-stat-card"><span>Victorias</span><strong id="profileWins">-</strong></div>
                <div class="profile-stat-card"><span>Derrotas</span><strong id="profileLosses">-</strong></div>
                <div class="profile-stat-card"><span>Win Rate</span><strong id="profileWinRate">-</strong></div>
                <div class="profile-stat-card"><span>Streams totales</span><strong id="profileStreams">-</strong></div>
                <div class="profile-stat-card full"><span>MTR apostados</span><strong id="profileWagered">-</strong></div>
            </div>

            <div class="profile-recent-section">
                <h3>√öltimas partidas</h3>
                <div id="profileRecentMatches" class="profile-recent-list">
                    <p class="profile-empty">Sin partidas a√∫n.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Match Challenge Modal -->
    <div id="challengeModal" class="modal hidden">
        <div class="modal-overlay" onclick="closeChallengeModal()"></div>
        <div class="modal-content">
            <button type="button" onclick="closeChallengeModal()" class="modal-close">√ó</button>
            <h2 class="auth-title">‚öîÔ∏è Reto R√°pido</h2>
            <p class="auth-subtitle" id="challengeDetails">Tienes un reto pendiente</p>
            <div class="challenge-actions">
                <button type="button" onclick="acceptChallenge()" class="btn-primary btn-block">Aceptar</button>
                <button type="button" onclick="rejectChallenge()" class="btn-secondary btn-block">Rechazar</button>
            </div>
        </div>
    </div>

    <!-- Contacto -->
    <section id="contactSection" class="contact-section">
        <div class="contact-card">
            <h2>Contacto</h2>
            <p>¬øTienes dudas o necesitas ayuda? Escr√≠benos a <a href="mailto:support@musictokenring.xyz">support@musictokenring.xyz</a>.</p>
            <form class="contact-form" onsubmit="submitContactForm(event)">
                <div class="form-group">
                    <label for="contactName">Nombre</label>
                    <input type="text" id="contactName" class="form-input" placeholder="Tu nombre" required>
                </div>
                <div class="form-group">
                    <label for="contactEmail">Email</label>
                    <input type="email" id="contactEmail" class="form-input" placeholder="tu@email.com" required>
                </div>
                <div class="form-group">
                    <label for="contactMessage">Mensaje</label>
                    <textarea id="contactMessage" class="form-input" rows="4" placeholder="Cu√©ntanos en qu√© podemos ayudarte" required></textarea>
                </div>
                <button type="submit" class="btn-primary">Enviar mensaje</button>
            </form>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="/privacy.html" class="footer-link">Privacy Policy</a>
                <a href="/terms.html" class="footer-link">Terms of Service</a>
                <a href="#contactSection" class="footer-link">Contact</a>
            </div>
            <p class="footer-copyright">
                ¬© 2026 MusicToken Ring. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="./auth-system.js?v=20260228mtr2"></script>
    <script src="./game-engine.js?v=20260228mtr2"></script>
    <script>window.MTR_INLINE_TOP_STREAMS_ACTIVE = true;</script>
 codex/fix-issues-from-codex-review-on-pr-#117-js14p8
    <script src="./app.js?v=20260228mtr2"></script>
    <script src="./top-streams-fallback.js?v=20260228mtr2"></script>

 codex/fix-issues-from-codex-review-on-pr-#117-yqd0oa
    <script src="./app.js?v=20260228mtr2"></script>
    <script src="./top-streams-fallback.js?v=20260228mtr2"></script>

 codex/fix-issues-from-codex-review-on-pr-#117-snau6z
    <script src="./app.js?v=20260228mtr2"></script>
    <script src="./top-streams-fallback.js?v=20260228mtr2"></script>

    <script src="./app.js?v=20260227mtr-hotfix-ui2"></script>
    <script src="./top-streams-fallback.js?v=20260227mtr-hotfix-ui2"></script>
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v






    <script>


        // Dashboard inline fallback removed; using top-streams-fallback.js


        (function () {
            if (window.MTR_INLINE_TOP_STREAMS_ACTIVE) {
                return;
            }
            if (window.__MTR_TOP_STREAMS_EXTERNAL__) {
                return;
            }
            var dashboardRegion = 'latam';
            var dashboardOffset = 0;

            function getDashboardList() {
                return document.getElementById('streamDashboardTrackList');
            }

            function tracksByRegion(region) {
                var data = {
                    latam: [
                        { title: 'Luna', artist: 'Feid', cover: 'https://e-cdns-images.dzcdn.net/images/cover/9f4c9025e2f4f4be85a8d0f95f3bc5fe/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 18.4% del top' },
                        { title: 'Si Antes Te Hubiera Conocido', artist: 'KAROL G', cover: 'https://e-cdns-images.dzcdn.net/images/cover/4aa4b9f4674f7f9f7428962456f31cc7/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 15.9% del top' },
                        { title: 'Perro Negro', artist: 'Bad Bunny', cover: 'https://e-cdns-images.dzcdn.net/images/cover/236f9df9f6f95cc8c6f0707dbe6839df/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 14.8% del top' },
                        { title: 'La Falda', artist: 'Myke Towers', cover: 'https://e-cdns-images.dzcdn.net/images/cover/3aebce9e3ec736beee8da30258aab6fa/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 12.9% del top' },
                        { title: 'Gata Only', artist: 'FloyyMenor', cover: 'https://e-cdns-images.dzcdn.net/images/cover/83d2abea3f2826f384749fd84d836c8e/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 11.3% del top' },
                        { title: 'Punter√≠a', artist: 'Shakira', cover: 'https://e-cdns-images.dzcdn.net/images/cover/3f1582203c1667b663219c2f47825550/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 10.2% del top' },
                        { title: 'QLO', artist: 'Young Miko', cover: 'https://e-cdns-images.dzcdn.net/images/cover/f15d8bc1ecf71ac95f640117f4d5e585/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 8.7% del top' },
                        { title: 'Adivino', artist: 'Bad Bunny', cover: 'https://e-cdns-images.dzcdn.net/images/cover/e1d6d6c45f7ec902f9b2e8db0f9d377f/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 7.8% del top' }
                    ],
                    us: [
                        { title: 'Espresso', artist: 'Sabrina Carpenter', cover: 'https://e-cdns-images.dzcdn.net/images/cover/94bfaf6f3b278ba8e56ef8fca0ca65a4/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 17.8% del top' },
                        { title: 'Lose Control', artist: 'Teddy Swims', cover: 'https://e-cdns-images.dzcdn.net/images/cover/c025cd9e3f0980d7f33173f66c66fdfd/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 15.9% del top' },
                        { title: 'Beautiful Things', artist: 'Benson Boone', cover: 'https://e-cdns-images.dzcdn.net/images/cover/4ff4d2e2e89ae5fd3df5e6eabf78f8f6/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 14.4% del top' },
                        { title: 'Too Sweet', artist: 'Hozier', cover: 'https://e-cdns-images.dzcdn.net/images/cover/7100802cbf6de021bf33f6f502838177/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 13.2% del top' },
                        { title: 'Fortnight', artist: 'Taylor Swift', cover: 'https://e-cdns-images.dzcdn.net/images/cover/46dc36370b32276115be5f66f8f70855/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 11.6% del top' },
                        { title: 'I Had Some Help', artist: 'Post Malone', cover: 'https://e-cdns-images.dzcdn.net/images/cover/2b9d74ac9e3b4fe26c7c0e59101cf15f/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 10.1% del top' },
                        { title: 'Birds of a Feather', artist: 'Billie Eilish', cover: 'https://e-cdns-images.dzcdn.net/images/cover/221551f4f4d74f6d20f4f2af2cfcbf60/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 9.0% del top' },
                        { title: 'Please Please Please', artist: 'Sabrina Carpenter', cover: 'https://e-cdns-images.dzcdn.net/images/cover/0e3f4d3ac048f6a8b6b91f44389f6515/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 8.0% del top' }
                    ],
                    eu: [
                        { title: "Stumblin' In", artist: 'Cyril', cover: 'https://e-cdns-images.dzcdn.net/images/cover/3f4b8cf4be2f16ebf3d6f8cfad8aa7c1/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 18.2% del top' },
                        { title: 'Mwaki', artist: 'Zerb', cover: 'https://e-cdns-images.dzcdn.net/images/cover/cc8f20c021f39d8444ec4f7f6d1d6e57/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 16.5% del top' },
                        { title: 'Texas Hold Em', artist: 'Beyonce', cover: 'https://e-cdns-images.dzcdn.net/images/cover/c5dfcb2f5a13f5327dd58476fdd0f9ed/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 14.6% del top' },
                        { title: 'Pedro', artist: 'Jaxomy', cover: 'https://e-cdns-images.dzcdn.net/images/cover/7fe2fcc56bcf8b188ad1a2b8ad34ec08/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 12.9% del top' },
                        { title: 'We Pray', artist: 'Coldplay', cover: 'https://e-cdns-images.dzcdn.net/images/cover/88fbf030f40bb08f61aa11d77ec2a3f8/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 11.0% del top' },
                        { title: 'MILLION DOLLAR BABY', artist: 'Tommy Richman', cover: 'https://e-cdns-images.dzcdn.net/images/cover/53ef5b98c4f886d86fbf2deb4228bb0e/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 9.8% del top' },
                        { title: 'A Bar Song', artist: 'Shaboozey', cover: 'https://e-cdns-images.dzcdn.net/images/cover/18b0fef52ac2957e574c5f7a357f6ce2/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 8.8% del top' },
                        { title: 'Good Luck, Babe!', artist: 'Chappell Roan', cover: 'https://e-cdns-images.dzcdn.net/images/cover/d095db4ad8d9f6407781c38b3dd9df04/250x250-000000-80-0-0.jpg', stat: '‚Ä¢ 8.2% del top' }
                    ]
                };
                return data[region] || data.latam;
            }

            function clean(value) {
                var text = String(value || '');
                text = text.replace(/codex\/[^\s]+/gi, '').replace(/feature\/[^\s]+/gi, '').replace(/cargando\.{0,3}/gi, '').trim();
                return text;
            }

            function purgeInjectedArtifacts() {
                var list = getDashboardList();
                if (!list) return;
                var targets = list.querySelectorAll('.stream-card-info strong, .stream-card-info span');
                for (var i = 0; i < targets.length; i++) {
                    var node = targets[i];
                    var cleaned = clean(node.textContent || '');
                    if (!cleaned && node.matches('span.stream-delta')) cleaned = '‚Ä¢ N/D';
                    if (!cleaned && node.matches('span:not(.stream-delta)')) cleaned = 'Artista';
                    if (!cleaned && node.matches('strong')) cleaned = 'Sin t√≠tulo';
                    node.textContent = cleaned;
                }
            }

            function protectDashboardFromInjectedText() {
                var list = getDashboardList();
                if (!list || list.dataset.protected === '1') return;
                list.dataset.protected = '1';
                var observer = new MutationObserver(function () {
                    purgeInjectedArtifacts();
                });
                observer.observe(list, { childList: true, subtree: true, characterData: true });
            }

            function sanitizeDashboardCards() {
                var list = getDashboardList();
                if (!list) return;
                var cards = list.querySelectorAll('.stream-card');
                for (var i = 0; i < cards.length; i++) {
                    var info = cards[i].querySelector('.stream-card-info');
                    if (!info) continue;
                    var strong = info.querySelector('strong');
                    var spans = info.querySelectorAll('span');
                    if (!strong || spans.length < 2) continue;

                    var artist = spans[0];
                    var stat = spans[1];

                    strong.textContent = clean(strong.textContent || 'Sin t√≠tulo') || 'Sin t√≠tulo';
                    artist.textContent = clean(artist.textContent || 'Artista') || 'Artista';
                    stat.textContent = clean(stat.textContent || '‚Ä¢ N/D') || '‚Ä¢ N/D';

                    while (info.childNodes.length > 3) {
                        info.removeChild(info.lastChild);
                    }

                }
            }

            var fallbackCover = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2264%22 height=%2264%22 viewBox=%220 0 64 64%22%3E%3Crect width=%2264%22 height=%2264%22 rx=%2210%22 fill=%22%232f3542%22/%3E%3Ctext x=%2232%22 y=%2239%22 text-anchor=%22middle%22 font-size=%2226%22%3E%F0%9F%8E%B5%3C/text%3E%3C/svg%3E';
            function render(region) {
                var list = getDashboardList();
                if (!list) return;
                var tracks = tracksByRegion(region);
                var html = '';
                for (var i = 0; i < tracks.length; i++) {
                    var t = tracks[i];
                    var cover = t.cover || fallbackCover;
                    html += '<article class="stream-card">' +
                        '<img src="' + cover + '" alt="' + clean(t.title) + '">' +
                        '<div class="stream-card-info">' +
                        '<strong>' + clean(t.title) + '</strong>' +
                        '<span>' + clean(t.artist) + '</span>' +
                        '<span class="stream-delta neutral">' + clean(t.stat) + '</span>' +
                        '</div></article>';
                }
                list.innerHTML = html;
                var covers = list.querySelectorAll('img');
                for (var j = 0; j < covers.length; j++) {
                    covers[j].onerror = function () {
                        this.onerror = null;
                        this.src = fallbackCover;
                    };
                }
                sanitizeDashboardCards();

                window.moveDashboardCarousel(0);
            }

            window.setDashboardRegion = function (region) {
                dashboardRegion = region || 'latam';
                var btns = document.querySelectorAll('.stream-region-tab');
                for (var i = 0; i < btns.length; i++) {
                    var b = btns[i];
                    b.classList.toggle('active', b.dataset && b.dataset.region === dashboardRegion);
                }
                render(dashboardRegion);
            };

            window.moveDashboardCarousel = function (direction) {
                var list = getDashboardList();
                if (!list) return;
                if (typeof direction === 'number') dashboardOffset = Math.max(0, dashboardOffset + direction);
                var step = Math.max(220, Math.floor(list.clientWidth * 0.55));
                list.scrollTo({ left: dashboardOffset * step, behavior: 'smooth' });
            };

            document.addEventListener('DOMContentLoaded', function () {
                render('latam');
                sanitizeDashboardCards();
                protectDashboardFromInjectedText();
                purgeInjectedArtifacts();
                setInterval(function () { sanitizeDashboardCards(); purgeInjectedArtifacts(); }, 1200);

                sanitizeDashboardCards();
                setInterval(sanitizeDashboardCards, 2000);

            });
        })();
        // Variables globales
        let selectedSong = null;
        window.__mtrOnChainBalance = Number(window.__mtrOnChainBalance || 0);
        let currentMode = null;


        // Verificar login al cargar
        document.addEventListener('DOMContentLoaded', async () => {
            initializePreferredNetwork();
            renderWalletDirectory();
 codex/fix-issues-from-codex-review-on-pr-#117-js14p8
            sanitizeInjectedGitArtifactsPage();

            renderCanonicalMtrInfoCard();
            sanitizeInjectedGitArtifacts();
            sanitizePaymentsAndMtrCards();
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (session) {
                    showModeSelector();
                    // Inicializar GameEngine
                    if (typeof GameEngine !== 'undefined') {
                        await GameEngine.init();
                    }
                } else {
                    showLoginWall();
                }

                const urlParams = new URLSearchParams(window.location.search);
                const modeParam = urlParams.get('mode');
                if (modeParam && ['quick', 'private', 'practice', 'tournament'].includes(modeParam)) {
                    selectMode(modeParam);
                    if (modeParam === 'practice') {
                        showToast('Elige otra canci√≥n para continuar en pr√°ctica.', 'info');
                    }
                }

                const roomParam = urlParams.get('room');
                sanitizeInjectedGitArtifactsPage();
                if (roomParam) {
                    selectMode('private');
                    document.getElementById('joinRoomCode').value = roomParam.toUpperCase();
                    showToast('Sala privada detectada. Selecciona tu canci√≥n para unirte.', 'info');
                }
            } catch (error) {
                console.error('Error inicializando sesi√≥n:', error);
                showLoginWall();
            }
            sanitizeInjectedGitArtifactsPage();
            setInterval(sanitizeInjectedGitArtifactsPage, 1200);
        });

        // Mostrar/ocultar secciones
        function showLoginWall() {
            document.getElementById('loginWall').classList.remove('hidden');
            document.getElementById('modeSelector').classList.add('hidden');
        }

        function showModeSelector() {
            document.getElementById('loginWall').classList.add('hidden');
            document.getElementById('modeSelector').classList.remove('hidden');
        }


        function sanitizePaymentsAndMtrCards() {
            const scope = document.querySelectorAll('.payments-showcase .settlement-card, .settlement-panel .settlement-card');
            if (!scope.length) return;

            const blocked = [
                /codex\/[\w.-]+/i,
                /feature\/[\w.-]+/i,
                /origin\/[\w.-]+/i,
                /branch\s+[\w./-]+/i,
                /https?:\/\/basescan\.org\//i
            ];

            scope.forEach((card) => {
                const elements = card.querySelectorAll('p, span, div');
                elements.forEach((el) => {
                    if (el.classList.contains('settlement-grid')) return;
                    const textValue = (el.textContent || '').trim();
                    if (!textValue) return;
                    if (!blocked.some((rule) => rule.test(textValue))) return;

                    if (el.querySelector('a,button,input')) {
                        Array.from(el.childNodes).forEach((node) => {
                            if (node.nodeType === Node.TEXT_NODE && blocked.some((rule) => rule.test(node.nodeValue || ''))) {
                                node.nodeValue = '';
                            }
                        });
                        return;
                    }

                    el.remove();
                });

                const walker = document.createTreeWalker(card, NodeFilter.SHOW_TEXT);
                const textNodes = [];
                while (walker.nextNode()) textNodes.push(walker.currentNode);
                textNodes.forEach((node) => {
                    const value = (node.nodeValue || '').trim();
                    if (!value) return;
                    if (!blocked.some((rule) => rule.test(value))) return;
                    node.nodeValue = '';
                });
            });
        }

        function renderCanonicalMtrInfoCard() {
            const card = document.getElementById('mtrInfoCard');
            if (!card) return;

            card.innerHTML = `
                <p>Token ERC-20 en Base. Liquidez lockeada en Aerodrome.</p>
                <p>Contrato: 0x99cd1eb32846c9027ed9cb8710066fa08791c33b.</p>
                <p>Contrato verificado: 0x99cd1eb32846c9027ed9cb8710066fa08791c33b ‚ÄîSupply total: 99,990,000 MTR.</p>
                <div class="settlement-grid">
                    <a class="btn-primary" target="_blank" rel="noopener noreferrer" href="https://basescan.org/token/0x99cd1eb32846c9027ed9cb8710066fa08791c33b">üìà Ver token MTR en Basescan</a>
                    <p class="settlement-help">Este bot√≥n abre el explorer del token para ver supply, holders y transacciones.</p>
                </div>
            `;
        }

        function sanitizeInjectedGitArtifacts() {
            const settlementPanel = document.querySelector('.settlement-panel');
            if (!settlementPanel) return;

            const blockedPatterns = [
                /codex\/migrate-/i,
                /feature\/wall-street-v2/i,
                /origin\/(main|feature)/i,
                /branch\s+[a-z0-9._\/-]+/i
            ];

            const walker = document.createTreeWalker(settlementPanel, NodeFilter.SHOW_TEXT);
            const textNodes = [];
            while (walker.nextNode()) textNodes.push(walker.currentNode);

            textNodes.forEach((node) => {
                const value = (node.nodeValue || '').trim();
                if (!value) return;
                if (!blockedPatterns.some((pattern) => pattern.test(value))) return;
                node.nodeValue = '';
            });
        }

        function initializePreferredNetwork() {
            const selector = document.getElementById('preferredNetwork');
            if (!selector || typeof PLATFORM_WALLET_ADDRESSES === 'undefined') return;

            const stored = localStorage.getItem('mtr_preferred_network') || 'base';
            const options = Object.keys(PLATFORM_WALLET_ADDRESSES).map((network) => {
                const label = network === 'base' ? 'Base (8453)' : network.charAt(0).toUpperCase() + network.slice(1);
                const selected = network === stored ? 'selected' : '';
                return `<option value="${network}" ${selected}>${label}</option>`;
            }).join('');

            selector.innerHTML = options;
            localStorage.setItem('mtr_preferred_network', selector.value || stored);
        }

        function setPreferredNetwork(network) {
            localStorage.setItem('mtr_preferred_network', network);
            renderWalletDirectory(network);
            showToast(`Red activa: ${network.toUpperCase()} (chainId 8453)`, 'success');
        }

        function submitContactForm(event) {
            event.preventDefault();
            const name = document.getElementById('contactName').value.trim();
            const email = document.getElementById('contactEmail').value.trim();
            const message = document.getElementById('contactMessage').value.trim();
            const subject = encodeURIComponent(`Soporte MusicToken Ring - ${name}`);
            const body = encodeURIComponent(`Nombre: ${name}\nEmail: ${email}\n\nMensaje:\n${message}`);
            window.location.href = `mailto:support@musictokenring.xyz?subject=${subject}&body=${body}`;
            showToast('Abriendo tu cliente de correo para enviar el mensaje.', 'success');
        }

        function copyWalletAddress(address, network) {
            navigator.clipboard.writeText(address);
            showToast(`Direcci√≥n de ${network.toUpperCase()} copiada`, 'success');
        }

        function renderWalletDirectory(selectedNetwork = null) {
            const walletDirectory = document.getElementById('walletDirectory');
            if (!walletDirectory || typeof PLATFORM_WALLET_ADDRESSES === 'undefined') return;

            const selector = document.getElementById('preferredNetwork');
            const activeNetwork = selectedNetwork || selector?.value || localStorage.getItem('mtr_preferred_network') || 'base';
            const selectedAddress = PLATFORM_WALLET_ADDRESSES[activeNetwork];

            if (!selectedAddress) {
                walletDirectory.innerHTML = '<div class="wallet-item"><span class="wallet-network">Sin red seleccionada</span></div>';
                return;
            }

            const label = activeNetwork.charAt(0).toUpperCase() + activeNetwork.slice(1);
            walletDirectory.innerHTML = `
                <div class="wallet-item">
                    <span class="wallet-network">${label}</span>
                    <span class="wallet-value">${selectedAddress}</span>
                    <button type="button" class="wallet-copy" onclick="copyWalletAddress('${selectedAddress}', '${activeNetwork}')">Copiar</button>
                </div>
            `;
        }


        function sanitizeInjectedGitArtifactsPage() {
            const suspiciousPattern = /(codex\/[\w\-./#]+|feature\/[\w\-./#]+|\bmain\s+codex\/[\w\-./#]+)/gi;
            const targets = document.querySelectorAll('.settlement-panel p, .settlement-panel a, .settlement-panel button, .payments-showcase p, .payments-showcase a');
            targets.forEach((node) => {
                const current = node.textContent || '';
                if (!current) return;
                const cleaned = current.replace(suspiciousPattern, '').replace(/\s{2,}/g, ' ').trim();
                if (cleaned !== current.trim()) {
                    if (node.tagName === 'A' || node.tagName === 'BUTTON') {
                        if (!cleaned) {
                            node.remove();
                            return;
                        }
                        node.textContent = cleaned;
                    } else if (cleaned) {
                        node.textContent = cleaned;
                    } else {
                        node.remove();
                    }
                }
            });

            const aboutCard = document.querySelector('.about-mtr-card');
            if (aboutCard) {
                const seen = new Set();
                aboutCard.querySelectorAll('p').forEach((p) => {
                    const key = (p.textContent || '').replace(/\s+/g, ' ').trim().toLowerCase();
                    if (!key) {
                        p.remove();
                        return;
                    }
                    if (seen.has(key)) {
                        p.remove();
                        return;
                    }
                    seen.add(key);
                });
            }
        }

        // Seleccionar modo
        function selectMode(mode) {
            currentMode = mode;
            window.currentMode = mode;
            document.getElementById('modeSelector').classList.add('hidden');
            document.getElementById('songSelection').classList.remove('hidden');
            
            const titles = {
                'quick': 'Modo R√°pido',
                'private': 'Sala Privada',
                'practice': 'Modo Pr√°ctica',
                'tournament': 'Modo Torneo'
            };
            document.getElementById('modeTitle').textContent = titles[mode];
            
            updateActionButtons(mode);
            if (typeof GameEngine !== 'undefined' && typeof GameEngine.updatePracticeBetDisplay === 'function') {
                GameEngine.updatePracticeBetDisplay();
            }
        }

        function backToModes() {
            document.getElementById('songSelection').classList.add('hidden');
            document.getElementById('modeSelector').classList.remove('hidden');
            window.currentMode = null;
            if (typeof GameEngine !== 'undefined' && typeof GameEngine.updatePracticeBetDisplay === 'function') {
                GameEngine.updatePracticeBetDisplay();
            }
            selectedSong = null;
        }

        // Actualizar botones seg√∫n modo
        function updateActionButtons(mode) {
            const buttonsDiv = document.getElementById('actionButtons');
            
            if (mode === 'quick') {
                buttonsDiv.innerHTML = `
                    <button type="button" onclick="startQuickMatch()" class="btn-primary btn-large" id="startQuickBtn" disabled>
                        ‚öîÔ∏è Buscar Rival
                    </button>
                `;
                const startQuickBtn = document.getElementById('startQuickBtn');
                if (startQuickBtn) startQuickBtn.dataset.baseState = 'ready';
                updateBetEligibility();
            } else if (mode === 'private') {
                buttonsDiv.innerHTML = `
                    <button type="button" onclick="createRoom()" class="btn-primary" id="createRoomBtn" disabled>
                        üé™ Crear Sala
                    </button>
                    <div class="or-divider">o</div>
                    <div class="join-room-group">
                        <input type="text" id="joinRoomCode" placeholder="C√≥digo" class="room-code-input" maxlength="6">
                        <button type="button" onclick="joinRoom()" class="btn-secondary" id="joinRoomBtn" disabled>
                            Unirse
                        </button>
                    </div>
                `;
            } else if (mode === 'practice') {
                buttonsDiv.innerHTML = `
                    <button type="button" onclick="startPractice()" class="btn-primary btn-large" id="startPracticeBtn" disabled>
                        üéØ Iniciar Pr√°ctica
                    </button>
                `;
            } else if (mode === 'tournament') {
                buttonsDiv.innerHTML = `
                    <div class="join-room-group">
                        <input type="text" id="tournamentId" placeholder="ID de torneo" class="room-code-input">
                        <button type="button" onclick="joinTournamentMode()" class="btn-primary" id="joinTournamentBtn" disabled>
                            üèÜ Unirme
                        </button>
                    </div>
                    <p class="section-subtitle" style="margin-top: 12px;">
                        El jackpot crece con un % de las comisiones cuando la plataforma supera el 90% del objetivo.
                    </p>
                `;
            }
        }

        // B√∫squeda de canciones
        function searchSong() {
            const query = document.getElementById('songSearch').value;
            if (query.trim()) {
                searchDeezer(query, 'searchResults');
            }
        }

        // Seleccionar canci√≥n
        async function selectSongForBattle(song) {
            if (typeof GameEngine !== 'undefined' && typeof GameEngine.ensureSongEligibleForMatchmaking === 'function') {
                const eloGate = await GameEngine.ensureSongEligibleForMatchmaking(song.id);
                if (!eloGate.allowed) {
                    showToast(eloGate.reason || 'Canci√≥n fuera del rango ELO permitido', 'error');
                    return;
                }
            }
            selectedSong = song;
            
            const cardDiv = document.getElementById('selectedSongCard');
            cardDiv.innerHTML = `
                <img src="${song.image}" alt="${song.name}" class="selected-song-image">
                <div class="selected-song-info">
                    <h4>${song.name}</h4>
                    <p>${song.artist}</p>
                </div>
            `;
            
            // Habilitar botones
            document.querySelectorAll('#actionButtons button').forEach(btn => {
                if (!btn.classList.contains('btn-disabled')) {
                    btn.disabled = false;
                }
            });
            updateBetEligibility();
        }

        // Apuesta r√°pida
        function quickBet(amount) {
            document.getElementById('betAmount').value = amount;
            updateBetEligibility();
        }


        function updateBetEligibility() {
            const startQuickBtn = document.getElementById('startQuickBtn');
            const betAmountEl = document.getElementById('betAmount');
            const onchainBalance = Number(window.__mtrOnChainBalance || 0);
            const bet = parseFloat(betAmountEl?.value || '0');
            if (!startQuickBtn) return;

            const canCoverBet = !!bet && onchainBalance >= bet;
            if (startQuickBtn.dataset.baseState === 'ready') {
                startQuickBtn.disabled = !canCoverBet;
            }

            if (!canCoverBet && bet > 0) {
                startQuickBtn.title = 'Saldo on-chain insuficiente para la apuesta';
            } else {
                startQuickBtn.title = '';
            }
        }

        // Iniciar seg√∫n modo
        async function startQuickMatch() {
            if (!selectedSong) return;
            const bet = parseInt(document.getElementById('betAmount').value) || 100;
            const onchainBalance = Number(window.__mtrOnChainBalance || 0);
            if (onchainBalance < bet) {
                showToast('Saldo on-chain insuficiente para esta apuesta', 'error');
                updateBetEligibility();
                return;
            }
            if (typeof GameEngine !== 'undefined') {
                await GameEngine.joinQuickMatch(selectedSong, bet);
            } else {
                showToast('GameEngine no est√° cargado', 'error');
            }
        }

        async function createRoom() {
            if (!selectedSong) return;
            const bet = parseInt(document.getElementById('betAmount').value) || 100;
            if (typeof GameEngine !== 'undefined') {
                await GameEngine.createPrivateRoom(selectedSong, bet);
            } else {
                showToast('GameEngine no est√° cargado', 'error');
            }
        }

        async function joinRoom() {
            if (!selectedSong) return;
            const roomCode = document.getElementById('joinRoomCode').value.toUpperCase();
            const bet = parseInt(document.getElementById('betAmount').value) || 100;
            if (typeof GameEngine !== 'undefined') {
                await GameEngine.joinPrivateRoom(roomCode, selectedSong, bet);
            } else {
                showToast('GameEngine no est√° cargado', 'error');
            }
        }

        async function startPractice() {
            if (!selectedSong) {
                showToast('Selecciona una canci√≥n primero', 'error');
                return;
            }

            const demoBet = parseInt(document.getElementById('betAmount').value) || 100;

            if (typeof GameEngine !== 'undefined') {
                await GameEngine.startPracticeMatch(selectedSong, demoBet);
            } else {
                showToast('Modo pr√°ctica en desarrollo', 'info');
            }
        }

        async function joinTournamentMode() {
            if (!selectedSong) return;
            const tournamentId = document.getElementById('tournamentId').value;
            if (!tournamentId) {
                showToast('Ingresa el ID del torneo', 'error');
                return;
            }
            const bet = parseInt(document.getElementById('betAmount').value) || 100;
            if (typeof GameEngine !== 'undefined') {
                await GameEngine.joinTournament(tournamentId, selectedSong, bet);
            } else {
                showToast('Modo torneo en desarrollo', 'info');
            }
        }

        function cancelSearch() {
            if (typeof GameEngine !== 'undefined' && typeof GameEngine.cancelMatchmaking === 'function') {
                GameEngine.cancelMatchmaking();
            } else {
                backToModes();
            }
        }

        function leaveRoom() {
            if (typeof GameEngine !== 'undefined' && typeof GameEngine.leavePrivateRoom === 'function') {
                GameEngine.leavePrivateRoom();
            } else {
                backToModes();
            }
        }

        function copyRoomCode() {
            const code = document.getElementById('roomCode').textContent;
            navigator.clipboard.writeText(code);
            if (typeof showToast !== 'undefined') {
                showToast('C√≥digo copiado', 'success');
            }
        }

        function copyRoomLink() {
            const link = document.getElementById('roomInviteLink').value;
            navigator.clipboard.writeText(link);
            if (typeof showToast !== 'undefined') {
                showToast('Link copiado', 'success');
            }
        }

        function showIncomingChallenge(challenge) {
            const modal = document.getElementById('challengeModal');
            const details = document.getElementById('challengeDetails');
            if (details) {
                details.textContent = `${challenge.song.name} - ${challenge.song.artist} | Apuesta: ${challenge.betAmount} MTR`;
            }
            modal.classList.remove('hidden');
        }

        function closeChallengeModal() {
            document.getElementById('challengeModal').classList.add('hidden');
        }

        function acceptChallenge() {
            closeChallengeModal();
            selectMode('quick');
            showToast('Reto aceptado. Selecciona tu canci√≥n para iniciar.', 'success');
        }

        function rejectChallenge() {
            if (typeof GameEngine !== 'undefined') {
                GameEngine.pendingChallenge = null;
            }
            closeChallengeModal();
            showToast('Reto rechazado', 'info');
        }
        async function quoteCashout() {
            const amount = parseFloat(document.getElementById('cashoutAmount')?.value || '0');
            if (!amount || amount <= 0) {
                showToast('Ingresa un monto v√°lido', 'error');
                return;
            }
            if (typeof GameEngine === 'undefined') {
                showToast('GameEngine no est√° cargado', 'error');
                return;
            }

            const quote = await GameEngine.getUsdSettlementQuote(amount);
            const quoteEl = document.getElementById('cashoutQuote');
            if (quoteEl && quote) {
                quoteEl.textContent = `Referencia: 1 MTR = $${quote.usdRate}. Neto estimado: $${quote.netUsd} (fee ${quote.feePercent}%).`;
            }
        }

        async function requestCashout() {
            const amount = parseFloat(document.getElementById('cashoutAmount')?.value || '0');
            if (!amount || amount <= 0) {
                showToast('Ingresa un monto v√°lido', 'error');
                return;
            }
            if (typeof GameEngine === 'undefined') {
                showToast('GameEngine no est√° cargado', 'error');
                return;
            }

            const payout = await GameEngine.requestCashout(amount, {
                network: 'base'
            });

            if (payout?.ok) {
                showToast(`Retiro solicitado: ${payout.requestId || 'ID pendiente'}`, 'success');
            }
        }

        function isBaseTxHash(value) {
            return /^0x([A-Fa-f0-9]{64})$/.test(value || '');
        }

        async function creditPurchasedMtr() {
            const txInput = document.getElementById('depositTxHash');
            const creditButton = document.getElementById('creditPurchaseBtn');
            const txHash = txInput?.value?.trim();
            if (!isBaseTxHash(txHash)) {
                showToast('Pega un hash v√°lido de Base (0x + 64 caracteres hex)', 'error');
                return;
            }
            if (typeof GameEngine === 'undefined') {
                showToast('GameEngine no est√° cargado', 'error');
                return;
            }

            if (creditButton) creditButton.disabled = true;
            try {
                const result = await GameEngine.verifyDepositAndCredit(txHash, { network: 'base' });
                if (result?.credited || typeof result?.newBalance === 'number') {
                    showToast('Compra acreditada. Ya puedes usar tu saldo en partidas pagadas.', 'success');
                    if (txInput) txInput.value = '';
                } else if (result?.status) {
                    showToast(`Estado de verificaci√≥n: ${result.status}`, 'info');
                }
            } finally {
                if (creditButton) creditButton.disabled = false;
            }
        }

 codex/fix-issues-from-codex-review-on-pr-#117-js14p8

 codex/fix-issues-from-codex-review-on-pr-#117-yqd0oa

 codex/fix-issues-from-codex-review-on-pr-#117-snau6z

 codex/fix-issues-from-codex-review-on-pr-#117-6lh27n
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
        const betAmountInput = document.getElementById('betAmount');
        if (betAmountInput) betAmountInput.addEventListener('input', updateBetEligibility);

        window.showIncomingChallenge = showIncomingChallenge;
        window.creditPurchasedMtr = creditPurchasedMtr;
        window.updateBetEligibility = updateBetEligibility;
 codex/fix-issues-from-codex-review-on-pr-#117-js14p8


 codex/fix-issues-from-codex-review-on-pr-#117-ttd7et
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
        const betAmountInput = document.getElementById('betAmount');
        if (betAmountInput) betAmountInput.addEventListener('input', updateBetEligibility);

        window.showIncomingChallenge = showIncomingChallenge;
        window.creditPurchasedMtr = creditPurchasedMtr;
        window.updateBetEligibility = updateBetEligibility;
 codex/fix-issues-from-codex-review-on-pr-#117-yqd0oa

 codex/fix-issues-from-codex-review-on-pr-#117-snau6z


        window.showIncomingChallenge = showIncomingChallenge;
        window.creditPurchasedMtr = creditPurchasedMtr;
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
    </script>

    <script type="module">
        import { createConfig, http, connect, getAccount, watchAccount, reconnect, readContract, switchChain } from 'https://esm.sh/@wagmi/core';
        import { base } from 'https://esm.sh/wagmi/chains';
        import { injected } from 'https://esm.sh/@wagmi/connectors';
        import { walletConnect } from 'https://esm.sh/@wagmi/connectors';
        import { formatUnits } from 'https://esm.sh/viem';

        const MTR_TOKEN = window.CONFIG?.MTR_TOKEN_ADDRESS || '0x99cd1eb32846c9027ed9cb8710066fa08791c33b';
        const ERC20_ABI = [
            { type: 'function', name: 'balanceOf', stateMutability: 'view', inputs: [{ name: 'account', type: 'address' }], outputs: [{ name: '', type: 'uint256' }] }
        ];

        const wagmiConfig = createConfig({
            chains: [base],
            connectors: [
                injected({ target: 'metaMask' }),
                walletConnect({ projectId: window.WALLETCONNECT_PROJECT_ID || 'demo-project-id' })
            ],
            transports: {
                [base.id]: http('https://mainnet.base.org')
            }
        });

        async function refreshMtrBalance(address) {
            if (!address) return;
            try {
                console.log('[wallet] reading MTR balance', { address });
                const balance = await readContract(wagmiConfig, {
                    address: MTR_TOKEN,
                    abi: ERC20_ABI,
                    functionName: 'balanceOf',
                    args: [address]
                });
                const numericBalance = Number(formatUnits(balance, 18));
                window.__mtrOnChainBalance = numericBalance;
                const formatted = numericBalance.toLocaleString('es-ES', { maximumFractionDigits: 4 });
 codex/fix-issues-from-codex-review-on-pr-#117-js14p8
                const badge = document.getElementById('onchainBalanceDisplay');
                const onchainBalance = document.getElementById('onchainMtrBalance');

 codex/fix-issues-from-codex-review-on-pr-#117-yqd0oa
                const badge = document.getElementById('onchainBalanceDisplay');
                const onchainBalance = document.getElementById('onchainMtrBalance');

 codex/fix-issues-from-codex-review-on-pr-#117-snau6z
                const badge = document.getElementById('onchainBalanceDisplay');
                const onchainBalance = document.getElementById('onchainMtrBalance');

 codex/fix-issues-from-codex-review-on-pr-#117-6lh27n
                const badge = document.getElementById('onchainBalanceDisplay');
                const onchainBalance = document.getElementById('onchainMtrBalance');

                const badge = document.getElementById('balanceDisplay');
                const userBalance = document.getElementById('userBalance');
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
                if (badge) badge.textContent = `Tu MTR: ${formatted}`;
                if (onchainBalance) onchainBalance.textContent = formatted;
                console.log('[wallet] MTR balance updated', { formatted });
            } catch (error) {
                console.error('[wallet] balance read error', error);
            }
        }

        function renderWallet(account) {
            const walletEl = document.getElementById('walletAddress');
            const btnEl = document.getElementById('walletConnectBtn');
            if (!walletEl || !btnEl) return;
            if (account?.address) {
                walletEl.textContent = `${account.address.slice(0, 6)}...${account.address.slice(-4)}`;
                walletEl.classList.remove('hidden');
                btnEl.textContent = 'Wallet conectada';
                localStorage.setItem('mtr_wallet', account.address);
                localStorage.setItem('mtr_wallet_chain', String(account.chainId || 'unknown'));
                if (account.chainId !== 8453) {
                    window.__mtrOnChainBalance = 0;
                    if (typeof showToast === 'function') showToast('Cambia a Base para MTR', 'error');
                } else {
                    refreshMtrBalance(account.address);
                }
                if (typeof window.updateBetEligibility === 'function') window.updateBetEligibility();
            } else {
                walletEl.classList.add('hidden');
                btnEl.textContent = 'Conectar Wallet';
                window.__mtrOnChainBalance = 0;
                const badge = document.getElementById('onchainBalanceDisplay');
                const onchainBalance = document.getElementById('onchainMtrBalance');
 codex/fix-issues-from-codex-review-on-pr-#117-js14p8
                if (badge) badge.textContent = 'On-chain: --';

 codex/fix-issues-from-codex-review-on-pr-#117-yqd0oa
                if (badge) badge.textContent = 'On-chain: --';

                if (badge) badge.textContent = 'Tu MTR: --';
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
 codex/migrate-mtoken-to-mtr-on-base-chain-hbd77v
                if (onchainBalance) onchainBalance.textContent = '--';
                if (typeof window.updateBetEligibility === 'function') window.updateBetEligibility();
            }
        }

        async function connectWalletWagmi() {
            try {
                console.log('[wallet] connect requested via wagmi');
                await connect(wagmiConfig, { connector: injected({ target: 'metaMask' }) });
                const account = getAccount(wagmiConfig);
                if (account?.chainId && account.chainId !== 8453) {
                    if (typeof showToast === 'function') showToast('Cambia a Base para MTR', 'error');
                    try {
                        await switchChain(wagmiConfig, { chainId: 8453 });
                    } catch (switchError) {
                        console.warn('[wallet] switch chain rejected', switchError);
                    }
                }
                renderWallet(getAccount(wagmiConfig));
            } catch (error) {
                console.error('[wallet] connect error', error);
                if (typeof showToast === 'function') showToast('No se pudo conectar la wallet', 'error');
            }
        }

        const btn = document.getElementById('walletConnectBtn');
        if (btn) btn.addEventListener('click', connectWalletWagmi);

        watchAccount(wagmiConfig, {
            onChange(account) {
                renderWallet(account);
            }
        });

        await reconnect(wagmiConfig);
        renderWallet(getAccount(wagmiConfig));
    </script>
</body>
</html>
